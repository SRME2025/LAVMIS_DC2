<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LAVMIS | Super User Dashboard & Analytics</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Luxon for date/time -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.0/build/global/luxon.min.js"></script>

    <style>
        /* All CSS styles remain exactly the same as before */
        :root { 
            --primary: #2c3e50; --accent: #8e44ad; --success: #27ae60; 
            --warning: #f39c12; --danger: #e74c3c; --light-bg: #f8f9fa;
            --border: #e0e0e0; --sidebar-width: 450px;
            --info: #3498db; --secondary: #95a5a6;
        }

        body { 
            margin: 0; 
            font-family: 'Segoe UI', sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* Navigation Tabs */
        .nav-bar { 
            background: var(--primary); 
            width: 70px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding-top: 20px; 
            gap: 25px; 
        }
        .nav-item { 
            color: #fff; 
            opacity: 0.6; 
            cursor: pointer; 
            font-size: 1.5rem; 
            transition: 0.3s; 
            position: relative; 
            width: 50px; 
            height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 10px; 
        }
        .nav-item:hover { 
            background: rgba(255,255,255,0.1); 
            opacity: 0.8; 
        }
        .nav-item.active { 
            opacity: 1; 
            color: var(--accent); 
            background: rgba(142, 68, 173, 0.1); 
        }
        .notification-badge { 
            position: absolute; 
            top: -5px; 
            right: -5px; 
            background: var(--danger); 
            color: white; 
            border-radius: 50%; 
            width: 22px; 
            height: 22px; 
            font-size: 0.7rem; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
        }

        .admin-notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Login Modal */
        #loginModal { 
            position: fixed; 
            inset: 0; 
            background: linear-gradient(135deg, #2c3e50, #000); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
        }
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 15px; 
            width: 380px; 
            text-align: center; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
        }
        .login-input { 
            width: 100%; 
            padding: 14px; 
            margin: 12px 0; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-size: 1rem; 
            transition: border 0.3s; 
        }
        .login-input:focus { 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1); 
        }
        .login-btn { 
            width: 100%; 
            padding: 14px; 
            background: var(--accent); 
            color: white; 
            border: none; 
            border-radius: 8px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 1rem; 
            transition: background 0.3s; 
            margin-top: 10px; 
        }
        .login-btn:hover { 
            background: #7d3c98; 
        }

        /* Sidebar & Views */
        #sidebar { 
            width: var(--sidebar-width); 
            background: white; 
            border-right: 1px solid var(--border); 
            display: flex; 
            flex-direction: column; 
            box-shadow: 2px 0 10px rgba(0,0,0,0.05); 
        }
        .view-content { 
            display: none; 
            flex-direction: column; 
            height: 100%; 
            overflow-y: auto; 
        }
        .view-content.active { 
            display: flex; 
        }

        /* Analytics Styles */
        .analytics-card { 
            margin: 15px; 
            padding: 25px; 
            background: white; 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
        }
        .report-table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.85rem; 
            margin-top: 15px; 
        }
        .report-table th { 
            text-align: left; 
            padding: 12px 15px; 
            background: var(--light-bg); 
            border-bottom: 2px solid var(--border); 
            font-weight: 600; 
            color: var(--primary); 
        }
        .report-table td { 
            padding: 12px 15px; 
            border-bottom: 1px solid var(--border); 
        }
        .report-table tr:hover { 
            background: rgba(142, 68, 173, 0.05); 
        }
        
        /* Filters Bar */
        .filters-bar { 
            padding: 15px; 
            background: var(--light-bg); 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            gap: 10px; 
            flex-wrap: wrap; 
            align-items: center; 
        }
        .filter-group { 
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        .filter-label { 
            font-size: 0.75rem; 
            color: #7f8c8d; 
            font-weight: 600; 
        }
        .filter-select { 
            padding: 8px 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            background: white; 
            font-size: 0.85rem; 
            min-width: 120px; 
        }
        .date-input { 
            padding: 8px 12px; 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            background: white; 
            font-size: 0.85rem; 
            width: 140px; 
        }
        
        /* Sidebar Item */
        .list-item { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            margin: 8px 15px; 
            cursor: pointer; 
            border-left: 4px solid #ddd; 
            transition: all 0.2s; 
            position: relative;
        }
        .list-item:hover { 
            transform: translateX(3px); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        }
        .list-item.status-approved { 
            border-left-color: var(--success); 
            background: linear-gradient(to right, rgba(39, 174, 96, 0.05), white); 
        }
        .list-item.status-pending { 
            border-left-color: var(--warning); 
            background: linear-gradient(to right, rgba(243, 156, 18, 0.05), white); 
        }
        .list-item.status-rejected { 
            border-left-color: var(--danger); 
            background: linear-gradient(to right, rgba(231, 76, 60, 0.05), white); 
        }
        .list-item.new-submission { 
            animation: pulse 2s infinite; 
            border: 2px solid var(--danger); 
        }
        
        /* Rate Preview Styles */
        .rate-preview {
            margin-top: 8px;
            padding: 6px 10px;
            background: rgba(142, 68, 173, 0.08);
            border-radius: 6px;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid var(--accent);
        }
        .rate-value {
            font-weight: bold;
            color: var(--accent);
        }
        .rate-label {
            color: #7f8c8d;
            font-size: 0.75rem;
        }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.4); } 
            70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } 
        }

        /* Map & Layout */
        #main { 
            flex: 1; 
            position: relative; 
            background: #f8f9fa; 
        }
        #map { 
            width: 100%; 
            height: 100%; 
        }
        .toolbar { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            z-index: 1000; 
            display: flex; 
            gap: 10px; 
        }
        .tool-btn { 
            background: white; 
            padding: 12px 20px; 
            border-radius: 30px; 
            border: 1px solid var(--border); 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            transition: all 0.2s; 
            font-size: 0.9rem; 
        }
        .tool-btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 6px 20px rgba(0,0,0,0.15); 
        }
        .tool-btn i { 
            font-size: 1.1rem; 
        }

        /* Show Property Button in List Item */
        .show-property-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            opacity: 0;
            pointer-events: none;
        }
        .list-item:hover .show-property-btn {
            opacity: 1;
            pointer-events: all;
        }
        .show-property-btn:hover {
            background: #7d3c98;
            transform: scale(1.05);
        }

        /* Zoom to Point Button */
        .zoom-to-point-btn {
            background: white;
            padding: 12px 20px;
            border-radius: 30px;
            border: 1px solid var(--border);
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
            color: var(--accent);
            position: absolute;
            top: 70px;
            right: 20px;
            z-index: 1000;
            display: none;
        }
        .zoom-to-point-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            background: var(--accent);
            color: white;
        }
        .zoom-to-point-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Review Modal */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.8); 
            z-index: 5000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(4px); 
        }
        .modal-content { 
            background: white; 
            width: 95%; 
            max-width: 1200px; 
            height: 90vh; 
            border-radius: 12px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .modal-body { 
            display: flex; 
            flex: 1; 
            overflow: hidden; 
        }
        .evidence-panel { 
            width: 40%; 
            background: #000; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            padding: 20px; 
            position: relative; 
        }
        .evidence-tabs { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 15px; 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 100; 
        }
        .evidence-tab { 
            background: rgba(51, 51, 51, 0.8); 
            color: white; 
            padding: 8px 15px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: background 0.3s; 
            backdrop-filter: blur(10px); 
        }
        .evidence-tab:hover { 
            background: rgba(51, 51, 51, 0.9); 
        }
        .evidence-tab.active { 
            background: var(--accent); 
        }
        .data-panel { 
            width: 60%; 
            padding: 25px; 
            overflow-y: auto; 
        }
        .data-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        .section-title { 
            font-weight: bold; 
            color: var(--accent); 
            margin: 25px 0 15px 0; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 8px; 
            font-size: 1.1rem; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .data-label { 
            font-size: 0.75rem; 
            color: #7f8c8d; 
            display: block; 
            margin-bottom: 4px; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .data-value { 
            font-size: 0.95rem; 
            font-weight: 600; 
            display: block; 
            margin-bottom: 12px; 
            color: var(--primary); 
            word-break: break-word; 
        }
        .data-group { 
            margin-bottom: 15px; 
            padding: 10px; 
            border-radius: 6px; 
            background: rgba(0,0,0,0.02); 
            transition: background 0.3s; 
        }
        .data-group:hover { 
            background: rgba(142, 68, 173, 0.05); 
        }
        .feedback-section { 
            margin-top: 25px; 
            padding: 20px; 
            background: var(--light-bg); 
            border-radius: 10px; 
            border: 1px solid var(--border); 
        }
        .feedback-textarea { 
            width: 100%; 
            min-height: 100px; 
            padding: 12px; 
            border: 2px solid var(--border); 
            border-radius: 8px; 
            margin: 10px 0; 
            font-family: inherit; 
            font-size: 0.9rem; 
            resize: vertical; 
            transition: border 0.3s; 
        }
        .feedback-textarea:focus { 
            border-color: var(--accent); 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1); 
        }
        .modal-footer { 
            padding: 20px; 
            border-top: 1px solid var(--border); 
            display: flex; 
            justify-content: flex-end; 
            gap: 15px; 
            background: var(--light-bg); 
        }

        /* Approval Dialog */
        .approval-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        .approval-dialog-content {
            background: white;
            width: 500px;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Charts */
        .chart-container { 
            margin: 15px 0; 
            position: relative; 
            height: 300px;
        }
        .chart-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .chart-box { 
            flex: 1; 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            border: 1px solid var(--border); 
            box-shadow: 0 3px 10px rgba(0,0,0,0.05); 
            min-height: 350px;
            display: flex; 
            flex-direction: column; 
        }
        .chart-title { 
            font-size: 0.95rem; 
            font-weight: 600; 
            margin-bottom: 15px; 
            color: var(--primary); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            flex-shrink: 0; 
        }
        .stat-card { 
            background: white; 
            border-radius: 10px; 
            padding: 20px; 
            margin: 10px 15px; 
            border: 1px solid var(--border); 
            display: flex; 
            align-items: center; 
            gap: 15px; 
        }
        .stat-icon { 
            width: 50px; 
            height: 50px; 
            border-radius: 12px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 1.5rem; 
        }
        .stat-info { 
            flex: 1; 
        }
        .stat-value { 
            font-size: 1.8rem; 
            font-weight: bold; 
            color: var(--primary); 
        }
        .stat-label { 
            font-size: 0.85rem; 
            color: #7f8c8d; 
            margin-top: 5px; 
        }

        /* Status Badge */
        .status-badge { 
            padding: 4px 12px; 
            border-radius: 20px; 
            font-size: 0.75rem; 
            font-weight: 600; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
        }
        .status-pending { 
            background: rgba(243, 156, 18, 0.1); 
            color: #f39c12; 
        }
        .status-approved { 
            background: rgba(39, 174, 96, 0.1); 
            color: #27ae60; 
        }
        .status-rejected { 
            background: rgba(231, 76, 60, 0.1); 
            color: #e74c3c; 
        }

        /* Toggle Switch */
        .toggle-switch { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 0.85rem; 
            color: var(--primary); 
            cursor: pointer; 
        }
        .toggle-slider { 
            width: 40px; 
            height: 20px; 
            background: #ddd; 
            border-radius: 20px; 
            position: relative; 
            transition: background 0.3s; 
        }
        .toggle-slider:after { 
            content: ''; 
            position: absolute; 
            width: 16px; 
            height: 16px; 
            background: white; 
            border-radius: 50%; 
            top: 2px; 
            left: 2px; 
            transition: transform 0.3s; 
        }
        .toggle-switch.active .toggle-slider { 
            background: var(--accent); 
        }
        .toggle-switch.active .toggle-slider:after { 
            transform: translateX(20px); 
        }

        /* Rejection Dialog */
        .rejection-dialog { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            backdrop-filter: blur(3px); 
        }
        .rejection-dialog-content { 
            background: white; 
            width: 500px; 
            border-radius: 12px; 
            padding: 30px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
            max-height: 80vh; 
            overflow-y: auto; 
        }
        .dialog-header { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--border); 
        }
        .dialog-icon { 
            width: 50px; 
            height: 50px; 
            background: var(--danger); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-size: 1.5rem; 
        }
        .dialog-title { 
            flex: 1; 
        }
        .dialog-title h3 { 
            margin: 0; 
            color: var(--primary); 
        }
        .dialog-title p { 
            margin: 5px 0 0 0; 
            color: #7f8c8d; 
            font-size: 0.9rem; 
        }
        .template-buttons { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px; 
            margin: 10px 0; 
        }
        .template-btn { 
            padding: 6px 12px; 
            background: var(--light-bg); 
            border: 1px solid var(--border); 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: all 0.2s; 
        }
        .template-btn:hover { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent); 
        }
        .template-btn:focus { 
            outline: none; 
        }
        .dialog-actions { 
            display: flex; 
            gap: 10px; 
            margin-top: 25px; 
            justify-content: flex-end; 
        }
        .dialog-btn { 
            padding: 12px 24px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            font-size: 0.9rem; 
            transition: all 0.2s; 
        }
        .dialog-btn.cancel { 
            background: var(--light-bg); 
            color: var(--primary); 
            border: 1px solid var(--border); 
        }
        .dialog-btn.cancel:hover { 
            background: #e9ecef; 
        }
        .dialog-btn.reject { 
            background: var(--danger); 
            color: white; 
        }
        .dialog-btn.reject:hover { 
            background: #c0392b; 
        }
        .dialog-btn.approve { 
            background: var(--success); 
            color: white; 
        }
        .dialog-btn.approve:hover { 
            background: #219653; 
        }

        /* Table Container for Analytics */
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        .table-container table {
            min-width: 800px;
        }

        /* Analytics Overview Table */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .analytics-table th {
            background: var(--light-bg);
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            border-bottom: 2px solid var(--border);
        }
        .analytics-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        .analytics-table tr:hover {
            background: rgba(142, 68, 173, 0.03);
        }

        /* Rejection Reason Input */
        .rejection-reason-section {
            margin: 20px 0;
            padding: 20px;
            background: #fff8f8;
            border-radius: 10px;
            border: 1px solid #ffcccc;
        }
        .rejection-reason-section h4 {
            margin: 0 0 15px 0;
            color: var(--danger);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .rejection-reason-input {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #ffcccc;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            transition: border 0.3s;
        }
        .rejection-reason-input:focus {
            outline: none;
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
        }
        .rejection-reason-input::placeholder {
            color: #999;
        }

        /* Edit Modal Styles */
        .edit-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(3px);
        }
        .edit-modal-content {
            background: white;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .edit-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }
        .edit-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .edit-form-group {
            margin-bottom: 15px;
        }
        .edit-form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .edit-form-group input,
        .edit-form-group select,
        .edit-form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border 0.3s;
            box-sizing: border-box;
        }
        .edit-form-group input:focus,
        .edit-form-group select:focus,
        .edit-form-group textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.1);
        }
        .edit-form-group textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }
        .edit-modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            background: var(--light-bg);
        }
        .edit-section-title {
            font-weight: bold;
            color: var(--accent);
            margin: 25px 0 15px 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Description Box for Review Modal */
        .description-box {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        /* Admin Notifications Panel Styles */
        .notifications-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 400px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 25px rgba(0,0,0,0.15);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        .notifications-panel.open {
            transform: translateX(0);
        }
        .notifications-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notifications-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        .close-notifications {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
        }
        .close-notifications:hover {
            background: rgba(255,255,255,0.2);
        }
        .notifications-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .notification-item {
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            border-radius: 10px;
            border: 1px solid var(--border);
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .notification-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .notification-item.unread {
            border-left: 4px solid var(--accent);
            background: linear-gradient(to right, rgba(142, 68, 173, 0.05), white);
        }
        .notification-item.read {
            opacity: 0.7;
        }
        .notification-type {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 8px;
        }
        .notification-type.rejection {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        .notification-type.approval {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        .notification-type.system {
            background: rgba(52, 152, 219, 0.1);
            color: var(--info);
        }
        .notification-type.new-submission {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        .notification-time {
            font-size: 0.75rem;
            color: #95a5a6;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .notification-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .notification-action-btn {
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
            transition: all 0.2s;
        }
        .notification-action-btn:hover {
            background: var(--light-bg);
        }
        .notification-action-btn.view {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }
        .notification-action-btn.view:hover {
            background: #7d3c98;
        }
        .no-notifications {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }
        .no-notifications i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        /* Admin Toast Notifications */
        .admin-toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            width: 350px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            overflow: hidden;
            animation: slideInRight 0.3s ease;
            border-left: 5px solid var(--accent);
        }
        .admin-toast.rejection {
            border-left-color: var(--danger);
        }
        .admin-toast.approval {
            border-left-color: var(--success);
        }
        .admin-toast-header {
            padding: 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-toast-body {
            padding: 15px;
        }
        .admin-toast-footer {
            padding: 10px 15px;
            background: var(--light-bg);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Notification Settings */
        .notification-settings {
            background: var(--light-bg);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        .settings-row:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-weight: 600;
            color: var(--primary);
        }
        .settings-description {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-top: 5px;
        }

        /* Lazy Loading Styles */
        .load-more-container {
            padding: 20px;
            text-align: center;
            border-top: 1px solid var(--border);
            margin-top: 15px;
        }
        .load-more-btn {
            padding: 10px 25px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 0 auto;
        }
        .load-more-btn:hover {
            background: #7d3c98;
        }
        .load-more-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading-more {
            padding: 15px;
            text-align: center;
            color: var(--primary);
            display: none;
        }
        .loading-more.active {
            display: block;
        }

        /* Revised Badge */
        .revised-badge {
            background: var(--accent);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: bold;
        }

        /* Highlighted Marker Styles */
        .highlighted-marker {
            animation: pulseHighlight 2s infinite;
            border: 3px solid white;
            box-shadow: 0 0 20px var(--accent);
        }
        @keyframes pulseHighlight {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(142, 68, 173, 0.7);
            }
            70% { 
                transform: scale(1.1);
                box-shadow: 0 0 0 10px rgba(142, 68, 173, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(142, 68, 173, 0);
            }
        }

        /* Selected Property Border */
        .selected-property {
            border: 3px solid var(--accent) !important;
            box-shadow: 0 0 15px rgba(142, 68, 173, 0.5) !important;
        }

        /* Marker Callout/Tooltip Styles */
        .marker-callout {
            position: absolute;
            transform: translate(-50%, -100%);
            background: white;
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 2px solid var(--border);
            min-width: 180px;
            max-width: 250px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .marker-callout.show {
            opacity: 0.95;
            transform: translate(-50%, -110%);
        }
        .callout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .callout-id {
            font-weight: bold;
            color: var(--primary);
            font-size: 0.9rem;
        }
        .callout-status {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        .callout-status.pending {
            background: rgba(243, 156, 18, 0.15);
            color: var(--warning);
        }
        .callout-status.approved {
            background: rgba(39, 174, 96, 0.15);
            color: var(--success);
        }
        .callout-status.rejected {
            background: rgba(231, 76, 60, 0.15);
            color: var(--danger);
        }
        .callout-content {
            font-size: 0.8rem;
            color: #555;
        }
        .callout-rate {
            color: var(--accent);
            font-weight: bold;
            margin-top: 5px;
            font-size: 0.85rem;
        }
        .callout-triangle {
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid white;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1));
        }
        .callout-triangle-border {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--border);
            z-index: -1;
        }

        /* Red Highlight Circle */
        .red-highlight-circle {
            border: 3px solid #e74c3c !important;
            background: rgba(231, 76, 60, 0.2) !important;
            animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed {
            0% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7);
            }
            70% { 
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(231, 76, 60, 0);
            }
            100% { 
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0);
            }
        }

        /* Animations */
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* New Analytics Tabs */
        .analytics-tabs {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: white;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
        }
        .analytics-tab {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            background: var(--light-bg);
            color: var(--primary);
        }
        .analytics-tab:hover {
            background: rgba(142, 68, 173, 0.1);
        }
        .analytics-tab.active {
            background: var(--accent);
            color: white;
        }

        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px;
        }
        .summary-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .summary-card h4 {
            margin: 0 0 15px 0;
            color: var(--primary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent);
            margin-bottom: 5px;
        }
        .summary-label {
            font-size: 0.8rem;
            color: #7f8c8d;
        }

        /* Enhanced Analytics Sections */
        .analytics-sub-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
        }
        .analytics-sub-tab {
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            color: var(--primary);
        }
        .analytics-sub-tab:hover {
            background: rgba(142, 68, 173, 0.1);
        }
        .analytics-sub-tab.active {
            background: var(--accent);
            color: white;
        }
        .analytics-section {
            display: none;
        }
        .analytics-section.active {
            display: block;
        }

        /* Parish Analytics */
        .parish-stats-card {
            background: var(--light-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent);
        }
        .parish-stats-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .parish-name {
            font-weight: bold;
            color: var(--primary);
            font-size: 1rem;
        }
        .parish-district {
            font-size: 0.8rem;
            color: var(--accent);
            background: rgba(142, 68, 173, 0.1);
            padding: 2px 8px;
            border-radius: 12px;
        }
        .parish-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .parish-stat-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        .parish-stat-value {
            font-weight: bold;
            color: var(--accent);
            font-size: 1.2rem;
        }
        .parish-stat-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            margin-top: 4px;
        }

    </style>
</head>
<body>

    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-box">
            <div style="background: var(--accent); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fa-solid fa-user-shield" style="color: white; font-size: 2rem;"></i>
            </div>
            <h2 style="color: var(--accent); margin-bottom: 10px;">SUPER USER CONSOLE</h2>
            <p style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 25px;">District Valuation & Market Analysis System</p>
            
            <input type="email" id="email" class="login-input" placeholder="Admin Email" autocomplete="username">
            <input type="password" id="password" class="login-input" placeholder="Password" autocomplete="current-password">
            
            <div style="margin: 15px 0; display: flex; align-items: center; gap: 8px;">
                <div class="toggle-switch" onclick="toggleRememberMe()">
                    <div class="toggle-slider"></div>
                    <span>Remember me</span>
                </div>
            </div>
            
            <button onclick="login()" class="login-btn" id="loginButton">
                <i class="fa-solid fa-right-to-bracket"></i> ACCESS CONSOLE
            </button>
            <p id="loginError" style="color: var(--danger); font-size: 0.85rem; margin-top: 15px; min-height: 20px;"></p>
            
            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
                <p style="font-size: 0.75rem; color: #7f8c8d;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Authorized Administrative Personnel Only
                </p>
            </div>
        </div>
    </div>

    <!-- Admin Notifications Panel -->
    <div id="adminNotificationsPanel" class="notifications-panel">
        <div class="notifications-header">
            <h3><i class="fa-solid fa-bell"></i> Admin Notifications</h3>
            <button class="close-notifications" onclick="closeNotificationsPanel()">&times;</button>
        </div>
        <div class="notifications-body" id="adminNotificationsBody">
            <!-- Notifications will be loaded here -->
        </div>
        <div style="padding: 15px; border-top: 1px solid var(--border);">
            <button onclick="markAllNotificationsAsRead()" class="tool-btn" style="width: 100%; padding: 10px;">
                <i class="fa-solid fa-check-double"></i> Mark All as Read
            </button>
        </div>
    </div>

    <!-- Navigation -->
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('map-view', this)" title="Map & Review">
            <i class="fa-solid fa-map-location-dot"></i>
            <span id="newSubmissionsBadge" class="notification-badge" style="display:none;">0</span>
        </div>
        <div class="nav-item" onclick="switchView('stats-view', this)" title="Analytics Dashboard">
            <i class="fa-solid fa-chart-pie"></i>
        </div>
        <div class="nav-item" onclick="switchView('users-view', this)" title="User Management">
            <i class="fa-solid fa-users-gear"></i>
        </div>
        <div class="nav-item" onclick="switchView('reports-view', this)" title="Reports">
            <i class="fa-solid fa-file-chart-column"></i>
        </div>
        <div class="nav-item" onclick="openNotificationsPanel()" title="Notifications" style="position: relative;">
            <i class="fa-solid fa-bell"></i>
            <span id="adminNotificationCount" class="admin-notification-badge" style="display:none;">0</span>
        </div>
        <div style="margin-top: auto; margin-bottom: 20px;">
            <div class="nav-item" onclick="logout()" title="Logout">
                <i class="fa-solid fa-power-off"></i>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="sidebar">
        <div style="padding:20px; background: var(--primary); color: white; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2 style="margin:0; font-size:1.2rem;">LAVMIS ADMIN</h2>
                <div id="adminEmail" style="font-size: 0.7rem; opacity: 0.7;"></div>
                <div id="lastRefresh" style="font-size: 0.65rem; opacity: 0.5; margin-top: 2px;"></div>
            </div>
            <div id="newSubmissionsCount" style="background: var(--danger); padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; display: none;">
                <i class="fa-solid fa-bell"></i> <span id="newCount">0</span> new
            </div>
        </div>

        <!-- Map View -->
        <div id="map-view" class="view-content active">
            <div class="filters-bar">
                <div class="filter-group">
                    <div class="filter-label">Search</div>
                    <input type="text" id="searchInput" placeholder="Property, Officer, ID..." class="filter-select" onkeyup="filterList()" style="width: 200px;">
                </div>
                <div class="filter-group">
                    <div class="filter-label">Status</div>
                    <select id="statusFilter" class="filter-select" onchange="filterList()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending Review</option>
                        <option value="approved">Approved</option>
                        <option value="rejected">Rejected</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Date Range</div>
                    <div style="display: flex; gap: 5px;">
                        <input type="date" id="dateFrom" class="date-input" onchange="filterList()">
                        <input type="date" id="dateTo" class="date-input" onchange="filterList()">
                    </div>
                </div>
                <div class="filter-group">
                    <div class="filter-label">Officer</div>
                    <select id="officerFilter" class="filter-select" onchange="filterList()">
                        <option value="all">All Officers</option>
                    </select>
                </div>
                <div class="filter-group">
                    <div class="filter-label">District</div>
                    <select id="districtFilter" class="filter-select" onchange="filterList()">
                        <option value="all">All Districts</option>
                    </select>
                </div>
                <button onclick="resetFilters()" class="tool-btn" style="padding: 8px 15px; font-size: 0.85rem; margin-top: 20px;">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>
            <div id="recordList" class="list-container" style="overflow-y: auto; flex: 1;"></div>
            
            <!-- Lazy Loading Container -->
            <div id="loadMoreContainer" class="load-more-container" style="display: none;">
                <button id="loadMoreBtn" class="load-more-btn" onclick="loadProperties(true)">
                    <i class="fa-solid fa-arrow-down"></i> Load More Records
                </button>
                <div id="loadingMore" class="loading-more">
                    <i class="fa-solid fa-spinner fa-spin"></i> Loading more records...
                </div>
            </div>
        </div>

        <!-- Analytics Dashboard -->
        <div id="stats-view" class="view-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; color: var(--primary);">
                    <i class="fa-solid fa-chart-line"></i> Analytics Dashboard
                </h3>
            </div>
            
            <!-- Analytics Time Period Tabs -->
            <div class="analytics-tabs">
                <div class="analytics-tab active" onclick="switchAnalyticsTab('weekly')">Weekly</div>
                <div class="analytics-tab" onclick="switchAnalyticsTab('monthly')">Monthly</div>
                <div class="analytics-tab" onclick="switchAnalyticsTab('quarterly')">Quarterly</div>
                <div class="analytics-tab" onclick="switchAnalyticsTab('annually')">Annually</div>
                <div style="flex:1;"></div>
                <select id="analyticsYear" class="filter-select" style="width: auto;" onchange="updateAnalyticsView()">
                    <option value="2024">2024</option>
                    <option value="2023">2023</option>
                    <option value="2022">2022</option>
                    <option value="all">All Time</option>
                </select>
            </div>

            <!-- Analytics Sub-Tabs -->
            <div class="analytics-sub-tabs">
                <div class="analytics-sub-tab active" onclick="switchAnalyticsSubTab('overview')">Overview</div>
                <div class="analytics-sub-tab" onclick="switchAnalyticsSubTab('districts')">District Analytics</div>
                <div class="analytics-sub-tab" onclick="switchAnalyticsSubTab('parishes')">Parish Analytics</div>
                <div class="analytics-sub-tab" onclick="switchAnalyticsSubTab('staff')">Staff Performance</div>
            </div>

            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryCards"></div>

            <!-- Overview Section -->
            <div id="overviewSection" class="analytics-section active">
                <!-- Time Period Analytics Tables -->
                <div class="analytics-card" id="weeklyAnalytics" style="display: block;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar-week"></i> Weekly Performance Overview
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="weeklyTable">
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Staff</th>
                                    <th>Active Districts</th>
                                </tr>
                            </thead>
                            <tbody id="weeklyBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="analytics-card" id="monthlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar-alt"></i> Monthly Performance Overview
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="monthlyTable">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Staff</th>
                                    <th>Active Districts</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="analytics-card" id="quarterlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar-alt"></i> Quarterly Performance Overview
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="quarterlyTable">
                            <thead>
                                <tr>
                                    <th>Quarter</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Staff</th>
                                    <th>Active Districts</th>
                                </tr>
                            </thead>
                            <tbody id="quarterlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="analytics-card" id="annuallyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-calendar"></i> Annual Performance Overview
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="annuallyTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Staff</th>
                                    <th>Active Districts</th>
                                </tr>
                            </thead>
                            <tbody id="annuallyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- District Analytics Section -->
            <div id="districtsSection" class="analytics-section">
                <!-- District Weekly Analytics -->
                <div class="analytics-card" id="districtWeeklyAnalytics">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-map-location-dot"></i> District Performance - Weekly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="districtWeeklyTable">
                            <thead>
                                <tr>
                                    <th>District</th>
                                    <th>Week</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="districtWeeklyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- District Monthly Analytics -->
                <div class="analytics-card" id="districtMonthlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-map-location-dot"></i> District Performance - Monthly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="districtMonthlyTable">
                            <thead>
                                <tr>
                                    <th>District</th>
                                    <th>Month</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="districtMonthlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- District Quarterly Analytics -->
                <div class="analytics-card" id="districtQuarterlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-map-location-dot"></i> District Performance - Quarterly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="districtQuarterlyTable">
                            <thead>
                                <tr>
                                    <th>District</th>
                                    <th>Quarter</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="districtQuarterlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- District Annual Analytics -->
                <div class="analytics-card" id="districtAnnuallyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-map-location-dot"></i> District Performance - Annually
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="districtAnnuallyTable">
                            <thead>
                                <tr>
                                    <th>District</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="districtAnnuallyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Parish Analytics Section -->
            <div id="parishesSection" class="analytics-section">
                <!-- Parish Weekly Analytics -->
                <div class="analytics-card" id="parishWeeklyAnalytics">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-church"></i> Parish Performance - Weekly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="parishWeeklyTable">
                            <thead>
                                <tr>
                                    <th>Parish</th>
                                    <th>District</th>
                                    <th>Week</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="parishWeeklyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Parish Monthly Analytics -->
                <div class="analytics-card" id="parishMonthlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-church"></i> Parish Performance - Monthly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="parishMonthlyTable">
                            <thead>
                                <tr>
                                    <th>Parish</th>
                                    <th>District</th>
                                    <th>Month</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="parishMonthlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Parish Quarterly Analytics -->
                <div class="analytics-card" id="parishQuarterlyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-church"></i> Parish Performance - Quarterly
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="parishQuarterlyTable">
                            <thead>
                                <tr>
                                    <th>Parish</th>
                                    <th>District</th>
                                    <th>Quarter</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="parishQuarterlyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Parish Annual Analytics -->
                <div class="analytics-card" id="parishAnnuallyAnalytics" style="display: none;">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-church"></i> Parish Performance - Annually
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="parishAnnuallyTable">
                            <thead>
                                <tr>
                                    <th>Parish</th>
                                    <th>District</th>
                                    <th>Year</th>
                                    <th>Total</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                    <th>Active Officers</th>
                                </tr>
                            </thead>
                            <tbody id="parishAnnuallyBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Parish Summary Cards -->
                <div class="analytics-card">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-church"></i> Top Performing Parishes
                    </h4>
                    <div id="topParishesContainer" class="parish-stats-grid"></div>
                </div>
            </div>

            <!-- Staff Performance Section -->
            <div id="staffSection" class="analytics-section">
                <div class="analytics-card">
                    <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-users"></i> Staff Performance Summary
                    </h4>
                    <div class="table-container">
                        <table class="analytics-table" id="staffPerformanceTable">
                            <thead>
                                <tr>
                                    <th>Staff Name</th>
                                    <th>Email</th>
                                    <th>Total Submissions</th>
                                    <th>Pending</th>
                                    <th>Approved</th>
                                    <th>Rejected</th>
                                    <th>Approval Rate</th>
                                    <th>Avg. Value/Ha</th>
                                    <th>Total Value</th>
                                </tr>
                            </thead>
                            <tbody id="staffPerformanceBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management View -->
        <div id="users-view" class="view-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border);">
                <h3 style="margin: 0; color: var(--primary);">
                    <i class="fa-solid fa-users-gear"></i> User Management
                </h3>
            </div>
            
            <div class="analytics-card">
                <h4 style="margin-top:0; display: flex; justify-content: space-between; align-items: center;">
                    <span><i class="fa-solid fa-user-plus"></i> Add New Admin</span>
                    <button onclick="showAddUserModal()" class="tool-btn" style="padding: 8px 15px; font-size: 0.85rem;">
                        <i class="fa-solid fa-plus"></i> Add User
                    </button>
                </h4>
                
                <div style="background: var(--light-bg); padding: 20px; border-radius: 8px; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary);">Full Name</label>
                            <input type="text" id="newUserName" class="login-input" placeholder="Enter full name" style="margin: 0;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary);">Email</label>
                            <input type="email" id="newUserEmail" class="login-input" placeholder="Enter email" style="margin: 0;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary);">Password</label>
                            <input type="password" id="newUserPassword" class="login-input" placeholder="Enter password" style="margin: 0;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--primary);">Role</label>
                            <select id="newUserRole" class="login-input" style="margin: 0; padding: 12px;">
                                <option value="admin">Administrator</option>
                                <option value="reviewer">Reviewer</option>
                                <option value="viewer">Viewer</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addNewAdmin()" class="login-btn" style="margin-top: 20px;">
                        <i class="fa-solid fa-user-plus"></i> Create Admin Account
                    </button>
                </div>
            </div>

            <div class="analytics-card">
                <h4 style="margin-top:0;">
                    <i class="fa-solid fa-users-between-lines"></i> Active Administrators
                </h4>
                <div class="table-container">
                    <table class="analytics-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Created</th>
                                <th>Last Active</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="adminTableBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Notification Settings Section -->
            <div class="analytics-card">
                <h4 style="margin-top:0; display: flex; align-items: center; gap: 10px;">
                    <i class="fa-solid fa-bell"></i> Notification Settings
                </h4>
                <div class="notification-settings">
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">New Submission Alerts</div>
                            <div class="settings-description">Get notified when new properties are submitted for review</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleNotificationSetting(this, 'new_submissions')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">Approval/Rejection Confirmations</div>
                            <div class="settings-description">Get confirmation when your actions are completed</div>
                        </div>
                        <div class="toggle-switch active" onclick="toggleNotificationSetting(this, 'action_confirmation')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div>
                            <div class="settings-label">System Updates</div>
                            <div class="settings-description">Receive notifications about system maintenance</div>
                        </div>
                        <div class="toggle-switch" onclick="toggleNotificationSetting(this, 'system_updates')">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports View -->
        <div id="reports-view" class="view-content">
            <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: var(--primary);">
                    <i class="fa-solid fa-file-chart-column"></i> Reports & Exports
                </h3>
            </div>
            
            <div class="analytics-card">
                <h4 style="margin-top:0;"><i class="fa-solid fa-file-export"></i> Export Approved Records</h4>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="exportApproved('geojson')">
                        <div style="color: var(--accent); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-globe"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">GeoJSON Export</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Export approved records as GeoJSON for GIS</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="exportApproved('excel')">
                        <div style="color: var(--success); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-file-excel"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Excel Export</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Export approved records to Excel format</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="exportApproved('csv')">
                        <div style="color: var(--info); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-file-csv"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">CSV Export</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Export approved records to CSV format</p>
                    </div>
                </div>
                
                <div style="background: var(--light-bg); padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <h5 style="margin: 0 0 15px 0; color: var(--primary);">
                        <i class="fa-solid fa-filter"></i> Filter Approved Records for Export
                    </h5>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary);">Date From</label>
                            <input type="date" id="exportDateFrom" class="date-input" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary);">Date To</label>
                            <input type="date" id="exportDateTo" class="date-input" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary);">Officer</label>
                            <select id="exportOfficer" class="filter-select" style="width: 100%;">
                                <option value="all">All Officers</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary);">District</label>
                            <select id="exportDistrict" class="filter-select" style="width: 100%;">
                                <option value="all">All Districts</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="exportFilteredApproved()" class="login-btn" style="width: 100%;">
                        <i class="fa-solid fa-download"></i> Export Filtered Approved Records
                    </button>
                </div>
            </div>
            
            <div class="analytics-card">
                <h4 style="margin-top:0;"><i class="fa-solid fa-chart-bar"></i> Generate Reports</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="generateReport('summary')">
                        <div style="color: var(--warning); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-file-lines"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Summary Report</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Overall statistics and performance summary</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="generateReport('detailed')">
                        <div style="color: var(--accent); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-file-circle-check"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Detailed Report</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Comprehensive data with all fields</p>
                    </div>
                    
                    <div style="background: white; padding: 20px; border-radius: 10px; border: 2px solid var(--border); cursor: pointer; transition: all 0.3s;" onclick="generateReport('officer')">
                        <div style="color: var(--info); font-size: 2rem; margin-bottom: 10px;">
                            <i class="fa-solid fa-user-tie"></i>
                        </div>
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">Officer Report</h4>
                        <p style="color: #7f8c8d; font-size: 0.85rem; margin: 0;">Performance analysis per officer</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Area -->
    <div id="main">
        <div class="toolbar">
            <button class="tool-btn" onclick="loadProperties(false)" title="Refresh Data">
                <i class="fa-solid fa-rotate"></i> Refresh
            </button>
            <button class="tool-btn" onclick="showOnlyPending()" style="color:var(--warning)" title="Show Only Pending">
                <i class="fa-solid fa-eye"></i> Pending
            </button>
            <button class="tool-btn" onclick="showAllOnMap()" style="color:var(--accent)" title="Show All on Map">
                <i class="fa-solid fa-map"></i> View All
            </button>
            <button class="tool-btn" onclick="exportApproved('geojson')" style="color:var(--success)" title="Export Approved Data">
                <i class="fa-solid fa-file-export"></i> Export
            </button>
            <div class="tool-btn" style="background: var(--primary); color: white; border: none;">
                <i class="fa-solid fa-database"></i>
                <span id="totalRecords">0</span> records
            </div>
        </div>
        
        <!-- Zoom to Selected Point Button -->
        <button id="zoomToPointBtn" class="zoom-to-point-btn" onclick="zoomToSelectedPoint()" title="Zoom to Selected Point">
            <i class="fa-solid fa-location-crosshairs"></i> Zoom to Point
        </button>
        
        <div id="map"></div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background: white;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h3 id="modalIdLabel" style="margin:0; display:inline; color: var(--primary);">Property ID</h3>
                    <span id="modalStatusBadge" class="status-badge" style="margin-left:10px;"></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.85rem; color: #7f8c8d;" id="modalTimestamp"></span>
                    <button onclick="closeModal()" style="border:none; background:none; cursor:pointer; font-size:1.5rem; color: #666; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                        &times;
                    </button>
                </div>
            </div>
            <div class="modal-body">
                <div class="evidence-panel">
                    <div class="evidence-tabs">
                        <div class="evidence-tab active" onclick="switchEvidenceTab('main')">
                            <i class="fa-solid fa-image"></i> Main Evidence
                        </div>
                        <div class="evidence-tab" onclick="switchEvidenceTab('location')">
                            <i class="fa-solid fa-map-location-dot"></i> Location
                        </div>
                        <div class="evidence-tab" onclick="switchEvidenceTab('additional')">
                            <i class="fa-solid fa-folder-plus"></i> Additional
                        </div>
                    </div>
                    <img id="review-img" style="max-width:100%; max-height:70%; object-fit: contain; border-radius: 8px;">
                    <div id="locationEvidence" style="display:none; color:white; text-align:center; margin-top:20px;">
                        <div id="locationMap" style="width: 100%; height: 300px; border-radius: 8px;"></div>
                        <p style="margin-top: 10px;">Property location on map</p>
                    </div>
                    <div id="additionalEvidence" style="display:none; color:white; text-align:center; margin-top:20px;">
                        <p>Additional evidence will appear here</p>
                    </div>
                </div>
                <div class="data-panel" id="modalDataContent"></div>
            </div>
            
            <div class="modal-footer">
                <button class="tool-btn" onclick="showRejectionDialog()" style="background:var(--danger); color:white; padding: 12px 25px;">
                    <i class="fa-solid fa-times"></i> Reject Submission
                </button>
                <button class="tool-btn" onclick="openEditModal()" style="background:var(--info); color:white; padding: 12px 25px;">
                    <i class="fa-solid fa-edit"></i> Edit Data
                </button>
                <button class="tool-btn" onclick="showApprovalDialog()" style="background:var(--success); color:white; padding: 12px 25px;">
                    <i class="fa-solid fa-check"></i> Approve Submission
                </button>
            </div>
        </div>
    </div>

    <!-- Approval Dialog -->
    <div id="approvalDialog" class="approval-dialog">
        <div class="approval-dialog-content">
            <div class="dialog-header">
                <div class="dialog-icon" style="background: var(--success);">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
                <div class="dialog-title">
                    <h3>Approve Property Submission</h3>
                    <p id="approvalDialogPropertyInfo">Confirm approval details</p>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--primary);">
                    <i class="fa-solid fa-user-check"></i> Approved By (Reviewer Name)
                </label>
                <input type="text" id="approverName" class="login-input" 
                       placeholder="Enter your name (this will be recorded as the approver)" 
                       style="margin: 0;">
                
                <div style="margin-top: 15px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--primary);">
                        <i class="fa-solid fa-comment"></i> Approval Notes (Optional)
                    </label>
                    <textarea id="approvalNotes" class="feedback-textarea" 
                              placeholder="Add any notes about this approval (optional)"></textarea>
                </div>
            </div>
            
            <div style="background: #d4edda; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745; margin: 20px 0;">
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <i class="fa-solid fa-info-circle" style="color: #155724; font-size: 1.2rem; margin-top: 2px;"></i>
                    <div>
                        <strong style="color: #155724;">Approval Confirmation:</strong>
                        <p style="color: #155724; margin: 5px 0 0 0; font-size: 0.9rem;">
                            This property will be marked as approved and will be included in exports and reports. 
                            The data collector will be notified of the approval.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="dialog-actions">
                <button class="dialog-btn cancel" onclick="closeApprovalDialog()">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
                <button class="dialog-btn approve" onclick="confirmApproval()">
                    <i class="fa-solid fa-check"></i> Confirm Approval
                </button>
            </div>
        </div>
    </div>

    <!-- Rejection Dialog -->
    <div id="rejectionDialog" class="rejection-dialog">
        <div class="rejection-dialog-content">
            <div class="dialog-header">
                <div class="dialog-icon">
                    <i class="fa-solid fa-times-circle"></i>
                </div>
                <div class="dialog-title">
                    <h3>Reject Property Submission</h3>
                    <p id="dialogPropertyInfo">Provide feedback for rejection</p>
                </div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--primary);">
                    <i class="fa-solid fa-comment-dots"></i> Rejection Feedback
                </label>
                <textarea id="rejectionFeedback" class="feedback-textarea" 
                          placeholder="Please provide specific reasons for rejection. This feedback will be sent to the data collector."></textarea>
                
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 10px; font-size: 0.9rem; color: var(--primary);">
                        <i class="fa-solid fa-bolt"></i> Quick Templates
                    </label>
                    <div class="template-buttons">
                        <button class="template-btn" onclick="useTemplate('insufficient_evidence')">Insufficient Evidence</button>
                        <button class="template-btn" onclick="useTemplate('incomplete_data')">Incomplete Data</button>
                        <button class="template-btn" onclick="useTemplate('location_issue')">Location Issue</button>
                        <button class="template-btn" onclick="useTemplate('duplicate')">Duplicate Entry</button>
                        <button class="template-btn" onclick="useTemplate('data_quality')">Data Quality</button>
                        <button class="template-btn" onclick="useTemplate('valuation_issue')">Valuation Issue</button>
                    </div>
                </div>
            </div>
            
            <!-- Reviewer Name Field -->
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: var(--primary);">
                    <i class="fa-solid fa-user-check"></i> Reviewer Name
                </label>
                <input type="text" id="reviewerName" class="login-input" 
                       placeholder="Enter your name (this will be recorded as the reviewer)" 
                       style="margin: 0;">
            </div>
            
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin: 20px 0;">
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <i class="fa-solid fa-info-circle" style="color: #856404; font-size: 1.2rem; margin-top: 2px;"></i>
                    <div>
                        <strong style="color: #856404;">Note to Data Collector:</strong>
                        <p style="color: #856404; margin: 5px 0 0 0; font-size: 0.9rem;">
                            This feedback will be sent to the data collector (<span id="collectorEmail">Unknown</span>) 
                            so they can make necessary corrections and resubmit the property information.
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="dialog-actions">
                <button class="dialog-btn cancel" onclick="closeRejectionDialog()">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
                <button class="dialog-btn reject" onclick="confirmRejection()">
                    <i class="fa-solid fa-paper-plane"></i> Send Rejection Feedback
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Data Modal -->
    <div id="editModal" class="edit-modal">
        <div class="edit-modal-content">
            <div class="modal-header" style="padding:15px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background: white;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h3 id="editModalIdLabel" style="margin:0; display:inline; color: var(--primary);">Edit Property Data</h3>
                    <span id="editModalStatusBadge" class="status-badge" style="margin-left:10px;"></span>
                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 0.85rem; color: #7f8c8d;" id="editModalTimestamp"></span>
                    <button onclick="closeEditModal()" style="border:none; background:none; cursor:pointer; font-size:1.5rem; color: #666; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                        &times;
                    </button>
                </div>
            </div>
            <div class="edit-modal-body" id="editModalBody">
                <!-- Edit form will be inserted here -->
            </div>
            <div class="edit-modal-footer">
                <button class="dialog-btn cancel" onclick="closeEditModal()">
                    <i class="fa-solid fa-times"></i> Cancel
                </button>
                <button class="dialog-btn" onclick="saveEditedData()" style="background:var(--success); color:white;">
                    <i class="fa-solid fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyA944hBt8QoOLeRKPoRrl2RemV9vlBc6ug",
            authDomain: "lavmis-1410e.firebaseapp.com",
            projectId: "lavmis-1410e",
            storageBucket: "lavmis-1410e.firebasestorage.app",
            messagingSenderId: "710897502113",
            appId: "1:710897502113:web:e5bfefc423af1b51632de0",
            measurementId: "G-ZWTN2R2RB2"
        };

        // Initialize Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        let allRecords = [];
        let map, markersGroup;
        let currentReviewId = null;
        let lastLoadTime = null;
        let newSubmissions = [];
        let currentUser = null;
        let locationMap = null;
        let editFormData = null;
        let adminNotifications = [];
        let adminNotificationListener = null;
        
        // Analytics view state
        let currentAnalyticsTab = 'weekly';
        let currentAnalyticsSubTab = 'overview';
        let analyticsYear = 'all';
        
        // Variables for map highlighting and callouts
        let selectedMarker = null;
        let highlightCircle = null;
        let allMarkers = new Map();
        let markerCallouts = new Map();
        
        let hoverTimeout = null;
        let currentHoveredMarkerId = null;
        const HOVER_DELAY = 300;
        
        // Pagination Variables
        let lastVisibleDoc = null;
        let isLoadingMore = false;
        let hasMoreRecords = true;
        const PAGE_SIZE = 50;

        // Template for feedback messages
        const feedbackTemplates = {
            insufficient_evidence: "The submission lacks sufficient photographic evidence. Please provide clear photos of the property from multiple angles showing boundaries and any structures.",
            incomplete_data: "Important required fields are missing or incomplete. Please ensure all mandatory fields are properly filled before resubmitting.",
            location_issue: "The GPS coordinates appear inaccurate or the location cannot be verified. Please ensure you have good GPS accuracy before capturing location.",
            duplicate: "This appears to be a duplicate entry of an existing property record. Please verify the property ID and details.",
            data_quality: "The data quality does not meet the required standards. Please review and improve the accuracy of information provided.",
            valuation_issue: "The valuation figures provided appear inconsistent with market rates. Please provide supporting documentation for the valuation."
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function parseFirestoreDate(dateField) {
            if (!dateField) return null;
            
            // Handle Firestore timestamp objects
            if (dateField && typeof dateField === 'object' && dateField.toDate) {
                return dateField.toDate();
            }
            
            // Handle JavaScript Date objects
            if (dateField instanceof Date) {
                return dateField;
            }
            
            // Handle string dates
            if (typeof dateField === 'string') {
                const parsed = new Date(dateField);
                if (!isNaN(parsed.getTime())) {
                    return parsed;
                }
            }
            
            // Handle number timestamps
            if (typeof dateField === 'number') {
                const parsed = new Date(dateField);
                if (!isNaN(parsed.getTime())) {
                    return parsed;
                }
            }
            
            return null;
        }

        function formatDate(date) {
            if (!date) return 'Unknown date';
            
            const dateObj = parseFirestoreDate(date);
            if (!dateObj) return 'Unknown date';
            
            return dateObj.toLocaleDateString() + ' ' + 
                   dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function formatISODate(date) {
            if (!date) return null;
            
            const dateObj = parseFirestoreDate(date);
            if (!dateObj) return null;
            
            return dateObj.toISOString().split('T')[0];
        }

        async function testFirestoreConnection() {
            try {
                const testDoc = await db.collection('properties').limit(1).get();
                console.log("Firestore connection test successful");
                return true;
            } catch (error) {
                console.error("Firestore connection test failed:", error);
                return false;
            }
        }

        function showNotification(message, type = "info") {
            const colors = {
                success: "var(--success)",
                warning: "var(--warning)",
                danger: "var(--danger)",
                info: "var(--info)",
                accent: "var(--accent)"
            };
            
            const bgColor = colors[type] || colors.info;
            
            const toast = document.createElement('div');
            toast.className = 'admin-toast';
            toast.style.borderLeftColor = bgColor;
            
            toast.innerHTML = `
                <div class="admin-toast-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fa-solid fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'times-circle' : 'info-circle'}" 
                           style="color: ${bgColor}"></i>
                        <strong>${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="background:none; border:none; color:#666; cursor:pointer;">
                        &times;
                    </button>
                </div>
                <div class="admin-toast-body">
                    ${message}
                </div>
                <div class="admin-toast-footer">
                    <button onclick="this.parentElement.parentElement.remove()" style="padding: 6px 12px; background: ${bgColor}; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Dismiss
                    </button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        if (toast.parentNode) toast.remove();
                    }, 300);
                }
            }, 5000);
        }

        // ============================================
        // MAP INITIALIZATION
        // ============================================
        function initMap() {
            map = L.map('map').setView([0.3476, 32.5825], 7);
            
            L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }).addTo(map);

            markersGroup = L.markerClusterGroup({
                chunkedLoading: true,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 50
            });
            map.addLayer(markersGroup);
            
            map.on('moveend', hideAllMarkerCallouts);
            map.on('zoomend', hideAllMarkerCallouts);
            map.on('click', hideAllMarkerCallouts);
        }

        // ============================================
        // MARKER CALLOUT FUNCTIONS (UPDATED with Rate per Acre)
        // ============================================
        function createMarkerCallout(recordId, data) {
            const marker = allMarkers.get(recordId);
            if (!marker) return null;
            
            const latlng = marker.getLatLng();
            const calloutId = `callout-${recordId}`;
            
            const existingCallout = document.getElementById(calloutId);
            if (existingCallout) {
                existingCallout.remove();
            }
            
            const callout = document.createElement('div');
            callout.id = calloutId;
            callout.className = 'marker-callout';
            
            const status = data.validationStatus || data.status || 'pending';
            const statusClass = status === 'pending' ? 'pending' : 
                               status === 'approved' ? 'approved' : 'rejected';
            
            const price = parseFloat(data.price) || 0;
            const size = parseFloat(data.size) || 1;
            const ratePerHa = size > 0 ? price / size : 0;
            const ratePerAcre = ratePerHa / 2.47105; // Conversion: 1 Ha = 2.47105 Acres
            
            callout.innerHTML = `
                <div class="callout-triangle-border"></div>
                <div class="callout-triangle"></div>
                <div class="callout-header">
                    <div class="callout-id">${data.propertyId || 'ID: N/A'}</div>
                    <div class="callout-status ${statusClass}">${status}</div>
                </div>
                <div class="callout-content">
                    ${data.propertyName || 'Unnamed Property'}<br>
                    ${data.districtCity || data.district || ''}
                </div>
                <div class="callout-rate">
                    Rate: Ugx ${Number(ratePerHa).toLocaleString()}/Ha<br>
                    <span style="font-size: 0.75rem; color: #7f8c8d;">(Ugx ${Number(ratePerAcre).toLocaleString()}/Acre)</span>
                </div>
            `;
            
            document.getElementById('map').appendChild(callout);
            markerCallouts.set(recordId, { element: callout, latlng });
            
            return callout;
        }

        function showMarkerCallout(recordId) {
            const callout = markerCallouts.get(recordId);
            if (!callout) return;
            
            const point = map.latLngToContainerPoint(callout.latlng);
            callout.element.style.left = point.x + 'px';
            callout.element.style.top = point.y + 'px';
            callout.element.classList.add('show');
        }

        function hideMarkerCallout(recordId) {
            const callout = markerCallouts.get(recordId);
            if (callout) {
                callout.element.classList.remove('show');
            }
        }

        function hideAllMarkerCallouts() {
            markerCallouts.forEach((callout) => {
                callout.element.classList.remove('show');
            });
        }

        function handleMarkerHover(recordId) {
            currentHoveredMarkerId = recordId;
            hoverTimeout = setTimeout(() => {
                if (currentHoveredMarkerId === recordId) {
                    const record = allRecords.find(r => r.firebaseId === recordId);
                    if (record) {
                        createMarkerCallout(recordId, record);
                        showMarkerCallout(recordId);
                    }
                }
            }, HOVER_DELAY);
        }

        function handleMarkerHoverOut(recordId) {
            clearTimeout(hoverTimeout);
            if (currentHoveredMarkerId === recordId) {
                currentHoveredMarkerId = null;
            }
            hideMarkerCallout(recordId);
        }

        // ============================================
        // MAP HIGHLIGHTING FUNCTIONS
        // ============================================
        function zoomToSelectedPoint() {
            if (selectedMarker) {
                map.setView(selectedMarker.getLatLng(), 15);
                highlightPointOnMap(currentReviewId);
            }
        }

        function highlightPointOnMap(recordId) {
            removeHighlight();
            
            const record = allRecords.find(r => r.firebaseId === recordId);
            if (!record || !record.latitude || !record.longitude) return;
            
            const lat = parseFloat(record.latitude);
            const lng = parseFloat(record.longitude);
            
            if (isNaN(lat) || isNaN(lng)) return;
            
            highlightCircle = L.circle([lat, lng], {
                color: '#e74c3c',
                fillColor: '#e74c3c',
                fillOpacity: 0.2,
                radius: 50,
                className: 'red-highlight-circle'
            }).addTo(map);
            
            const marker = allMarkers.get(recordId);
            if (marker) {
                selectedMarker = marker;
                const icon = marker.getIcon();
                icon.options.className += ' highlighted-marker';
                marker.setIcon(icon);
                
                createMarkerCallout(recordId, record);
                showMarkerCallout(recordId);
                
                map.panTo(selectedMarker.getLatLng());
            }
            
            document.getElementById('zoomToPointBtn').style.display = 'flex';
        }

        function removeHighlight() {
            if (highlightCircle) {
                highlightCircle.remove();
                highlightCircle = null;
            }
            
            if (selectedMarker) {
                const icon = selectedMarker.getIcon();
                icon.options.className = icon.options.className.replace(' highlighted-marker', '');
                selectedMarker.setIcon(icon);
                selectedMarker = null;
            }
            
            document.getElementById('zoomToPointBtn').style.display = 'none';
            hideAllMarkerCallouts();
        }

        function highlightListItem(recordId) {
            document.querySelectorAll('.list-item').forEach(item => {
                item.classList.remove('selected-property');
            });
            
            const listItem = document.querySelector(`.list-item[data-id="${recordId}"]`);
            if (listItem) {
                listItem.classList.add('selected-property');
                listItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // ============================================
        // ADD PROPERTY TO MAP CLUSTER
        // ============================================
        function addPropertyToCluster(id, data) {
            if (!data.latitude || !data.longitude) return;

            const lat = parseFloat(data.latitude);
            const lng = parseFloat(data.longitude);
            
            if (isNaN(lat) || isNaN(lng)) return;

            let markerColor;
            let iconClass;
            
            const status = data.validationStatus || data.status || 'pending';
            
            if (status === 'approved') {
                markerColor = '#27ae60';
                iconClass = 'fa-check-circle';
            } else if (status === 'rejected') {
                markerColor = '#e74c3c';
                iconClass = 'fa-times-circle';
            } else {
                markerColor = '#f39c12';
                iconClass = 'fa-clock';
            }
            
            const markerIcon = L.divIcon({
                html: `<div style="background: ${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 10px;">
                        <i class="fa-solid ${iconClass}"></i>
                      </div>`,
                className: 'custom-marker',
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
            
            const marker = L.marker([lat, lng], { icon: markerIcon });
            
            marker.on('mouseover', () => handleMarkerHover(id));
            marker.on('mouseout', () => handleMarkerHoverOut(id));
            
            marker.on('click', () => {
                currentReviewId = id;
                openReview(id);
                highlightPointOnMap(id);
                highlightListItem(id);
            });
            
            markersGroup.addLayer(marker);
            allMarkers.set(id, marker);
        }

        // ============================================
        // PROCESS AND STORE RECORD (UPDATED with Rate per Acre)
        // ============================================
        function processAndStoreRecord(id, data) {
            // Parse all date fields
            const createdAt = parseFirestoreDate(data.createdAt) || new Date();
            const updatedAt = parseFirestoreDate(data.updatedAt);
            const originallyQueuedAt = parseFirestoreDate(data.originallyQueuedAt);
            
            // Parse submission date - prioritize date field as shown in data structure
            let submissionDate = null;
            if (data.date) {
                submissionDate = parseFirestoreDate(data.date);
            }
            if (!submissionDate && data.submissionDate) {
                submissionDate = parseFirestoreDate(data.submissionDate);
            }
            if (!submissionDate && data.createdAt) {
                submissionDate = createdAt;
            }
            if (!submissionDate) {
                submissionDate = new Date();
            }

            // Parse coordinates
            let latitude = data.latitude;
            let longitude = data.longitude;
            
            // If coordinates string exists but lat/lng are missing, parse it
            if ((!latitude || !longitude) && data.coordinates) {
                const coords = data.coordinates.split(',').map(c => parseFloat(c.trim()));
                if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
                    latitude = coords[0];
                    longitude = coords[1];
                }
            }

            // Parse numeric values
            const price = parseFloat(data.price) || 0;
            const size = parseFloat(data.size) || 1;
            const rate = size > 0 ? price / size : 0;
            const ratePerAcre = rate / 2.47105; // Conversion: 1 Ha = 2.47105 Acres
            
            // Get officer email - prioritize userEmail as shown in data structure
            const officerEmail = data.userEmail || data.officerEmail || data.email || data.collectorEmail || '';
            const officerName = data.officerName || data.userName || 'Unknown Officer';
            
            // Get location hierarchy
            const district = data.districtCity || data.district || '';
            const districtCity = data.districtCity || data.district || '';
            const parish = data.parish || '';
            
            // Get status - look for validationStatus or status
            const status = data.validationStatus || data.status || 'pending';
            
            // Check if this is a revised submission
            const isRevised = (data.resubmissionCount && data.resubmissionCount > 0) || 
                              data.resubmittedAt || 
                              (data.originalSubmissionId);
            
            const processedRecord = {
                // Original document ID
                firebaseId: id,
                
                // Timestamps
                createdAt: createdAt,
                updatedAt: updatedAt,
                originallyQueuedAt: originallyQueuedAt,
                submissionDate: submissionDate,
                formattedDate: data.formattedDate || formatDate(submissionDate),
                
                // Property identifiers
                propertyId: data.propertyId || 'N/A',
                propertyName: data.propertyName || '',
                
                // Registration details
                registrationType: data.registrationType || 'titled',
                plotNumber: data.plotNumber || '',
                blockNumber: data.blockNumber || '',
                
                // Location hierarchy
                district: district,
                districtCity: districtCity,
                subcounty: data.subcounty || '',
                parish: parish,
                village: data.village || '',
                
                // Property details
                description: data.description || '',
                landUse: data.landUse || '',
                
                // Valuation (UPDATED with ratePerAcre)
                price: price,
                size: size,
                rate: rate,
                ratePerAcre: ratePerAcre,
                
                // Location data
                latitude: latitude,
                longitude: longitude,
                coordinates: data.coordinates || `${latitude || ''}, ${longitude || ''}`,
                locationMode: data.locationMode || '',
                positionSource: data.positionSource || '',
                gpsAccuracy: data.gpsAccuracy ? parseFloat(data.gpsAccuracy) : null,
                
                // Officer information
                officerName: officerName,
                officerEmail: officerEmail,
                userId: data.userId || '',
                
                // Evidence
                photo: data.photo || data.evidencePhotoUrl || data.photoUrl || null,
                evidence: data.evidence || null,
                
                // Data source
                dataSource: data.dataSource || '',
                syncStatus: data.syncStatus || 'synced',
                
                // Status
                status: status,
                validationStatus: status,
                
                // Revision tracking
                isRevised: isRevised,
                originalSubmissionId: data.originalSubmissionId || null,
                resubmissionCount: data.resubmissionCount || 0,
                resubmittedAt: parseFirestoreDate(data.resubmittedAt),
                
                // Review fields
                reviewedBy: data.reviewedBy || null,
                reviewedAt: parseFirestoreDate(data.reviewedAt),
                rejectionReason: data.rejectionReason || data.rejectionFeedback || null,
                approvalNotes: data.approvalNotes || null,
                
                // Keep all original data for reference
                rawData: data
            };
            
            const existingIndex = allRecords.findIndex(r => r.firebaseId === id);
            if (existingIndex !== -1) {
                allRecords[existingIndex] = processedRecord;
            } else {
                allRecords.push(processedRecord);
            }
            
            return processedRecord;
        }

        // ============================================
        // RENDER PROPERTY LIST ITEM (UPDATED with Rate per Acre)
        // ============================================
        function renderPropertyListItem(id, data) {
            const container = document.getElementById('recordList');
            
            const existingItem = Array.from(container.children).find(item => 
                item.dataset.id === id
            );
            
            if (existingItem) {
                updateRecordItem(existingItem, data);
            } else {
                const item = createRecordItem(data, id);
                container.appendChild(item);
            }
        }

        function createRecordItem(record, id) {
            const item = document.createElement('div');
            item.dataset.id = id;
            const recordStatus = record.validationStatus || record.status || 'pending';
            item.className = `list-item status-${recordStatus}`;
            
            // Check if new submission (submitted after last load)
            let isNew = false;
            if (record.submissionDate && lastLoadTime) {
                const subDate = parseFirestoreDate(record.submissionDate);
                if (subDate && subDate > lastLoadTime && recordStatus === 'pending') {
                    isNew = true;
                    newSubmissions.push({ firebaseId: id, ...record });
                }
            }
            
            if (isNew) {
                item.classList.add('new-submission');
            }
            
            const dateStr = formatDate(record.submissionDate);
            
            const price = parseFloat(record.price) || 0;
            const size = parseFloat(record.size) || 1;
            const ratePerHa = size > 0 ? price / size : 0;
            const ratePerAcre = ratePerHa / 2.47105;
            
            const displayLocation = record.districtCity || record.district || 'Unknown Location';
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: bold; color: var(--primary);">
                            ${record.propertyId || 'Unknown ID'}
                            ${record.isRevised ? '<span class="revised-badge">REVISED</span>' : ''}
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 5px; color: #7f8c8d;">${record.propertyName || 'Unnamed Property'}</div>
                        <div style="font-size: 0.8rem; color: var(--accent);">${displayLocation}</div>
                    </div>
                    <span class="status-badge status-${recordStatus}">
                        ${recordStatus}
                    </span>
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem;">
                    <div><i class="fa-solid fa-user-tie"></i> ${record.officerName || 'Unknown Officer'}</div>
                    <div><i class="fa-solid fa-envelope"></i> ${record.officerEmail || 'No email'}</div>
                    <div><i class="fa-solid fa-map-marker-alt"></i> ${displayLocation}</div>
                    <div><i class="fa-solid fa-calendar"></i> ${dateStr}</div>
                    ${price > 0 ? `<div><i class="fa-solid fa-money-bill-wave"></i> Ugx ${Number(price).toLocaleString()}</div>` : ''}
                    ${size > 0 ? `<div><i class="fa-solid fa-ruler-combined"></i> ${size} Ha</div>` : ''}
                    ${ratePerHa > 0 ? `<div class="rate-preview">
                        <div style="display: flex; flex-direction: column;">
                            <div>
                                <span class="rate-label">Rate per Ha:</span>
                                <span class="rate-value">Ugx ${Number(ratePerHa).toLocaleString()}</span>
                            </div>
                            <div style="margin-top: 3px;">
                                <span class="rate-label">Rate per Acre:</span>
                                <span class="rate-value" style="color: var(--info);">Ugx ${Number(ratePerAcre).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>` : ''}
                </div>
                <button class="show-property-btn" onclick="showPropertyOnMap('${id}'); event.stopPropagation();">
                    <i class="fa-solid fa-map-marker-alt"></i> Show on Map
                </button>
            `;
            
            item.onclick = () => {
                currentReviewId = id;
                openReview(id);
                highlightPointOnMap(id);
                highlightListItem(id);
            };
            return item;
        }

        function updateRecordItem(item, record) {
            const recordStatus = record.validationStatus || record.status || 'pending';
            item.className = `list-item status-${recordStatus}`;
            
            const isNew = newSubmissions.some(sub => sub.firebaseId === record.firebaseId);
            if (isNew) {
                item.classList.add('new-submission');
            } else {
                item.classList.remove('new-submission');
            }
            
            const dateStr = formatDate(record.submissionDate);
            
            const price = parseFloat(record.price) || 0;
            const size = parseFloat(record.size) || 1;
            const ratePerHa = size > 0 ? price / size : 0;
            const ratePerAcre = ratePerHa / 2.47105;
            
            const displayLocation = record.districtCity || record.district || 'Unknown Location';
            
            item.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: bold; color: var(--primary);">
                            ${record.propertyId || 'Unknown ID'}
                            ${record.isRevised ? '<span class="revised-badge">REVISED</span>' : ''}
                        </div>
                        <div style="font-size: 0.9rem; margin-top: 5px; color: #7f8c8d;">${record.propertyName || 'Unnamed Property'}</div>
                        <div style="font-size: 0.8rem; color: var(--accent);">${displayLocation}</div>
                    </div>
                    <span class="status-badge status-${recordStatus}">
                        ${recordStatus}
                    </span>
                </div>
                <div style="margin-top: 10px; font-size: 0.85rem;">
                    <div><i class="fa-solid fa-user-tie"></i> ${record.officerName || 'Unknown Officer'}</div>
                    <div><i class="fa-solid fa-envelope"></i> ${record.officerEmail || 'No email'}</div>
                    <div><i class="fa-solid fa-map-marker-alt"></i> ${displayLocation}</div>
                    <div><i class="fa-solid fa-calendar"></i> ${dateStr}</div>
                    ${price > 0 ? `<div><i class="fa-solid fa-money-bill-wave"></i> UGX ${Number(price).toLocaleString()}</div>` : ''}
                    ${size > 0 ? `<div><i class="fa-solid fa-ruler-combined"></i> ${size} Ha</div>` : ''}
                    ${ratePerHa > 0 ? `<div class="rate-preview">
                        <div style="display: flex; flex-direction: column;">
                            <div>
                                <span class="rate-label">Rate per Ha:</span>
                                <span class="rate-value">UGX ${Number(ratePerHa).toLocaleString()}</span>
                            </div>
                            <div style="margin-top: 3px;">
                                <span class="rate-label">Rate per Acre:</span>
                                <span class="rate-value" style="color: var(--info);">UGX ${Number(ratePerAcre).toLocaleString()}</span>
                            </div>
                        </div>
                    </div>` : ''}
                </div>
                <button class="show-property-btn" onclick="showPropertyOnMap('${record.firebaseId}'); event.stopPropagation();">
                    <i class="fa-solid fa-map-marker-alt"></i> Show on Map
                </button>
            `;
            
            item.onclick = () => {
                currentReviewId = record.firebaseId;
                openReview(record.firebaseId);
                highlightPointOnMap(record.firebaseId);
                highlightListItem(record.firebaseId);
            };
        }

        function showPropertyOnMap(recordId) {
            const record = allRecords.find(r => r.firebaseId === recordId);
            if (!record) return;
            
            highlightListItem(recordId);
            highlightPointOnMap(recordId);
            showNotification(`Showing property ${record.propertyId || recordId} on map`, "info");
        }

        // ============================================
        // OPEN REVIEW MODAL (UPDATED with Rate per Acre)
        // ============================================
        function openReview(recordId) {
            const record = allRecords.find(r => r.firebaseId === recordId);
            if (!record) return;
            
            currentReviewId = recordId;
            
            document.getElementById('modalIdLabel').textContent = record.propertyId || 'Unknown ID';
            
            const status = record.validationStatus || record.status || 'pending';
            const statusBadge = document.getElementById('modalStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge status-${status}`;
            
            const dateStr = formatDate(record.submissionDate);
            document.getElementById('modalTimestamp').textContent = `Submitted: ${dateStr}`;
            
            // Set evidence image
            const evidenceImg = document.getElementById('review-img');
            if (record.photo) {
                evidenceImg.src = record.photo;
                evidenceImg.style.display = 'block';
            } else if (record.evidencePhotoUrl) {
                evidenceImg.src = record.evidencePhotoUrl;
                evidenceImg.style.display = 'block';
            } else if (record.photoUrl) {
                evidenceImg.src = record.photoUrl;
                evidenceImg.style.display = 'block';
            } else {
                evidenceImg.style.display = 'none';
            }
            
            populateModalData(record);
            
            document.getElementById('reviewModal').style.display = 'flex';
            
            if (record.latitude && record.longitude) {
                setTimeout(() => {
                    initLocationMap(record.latitude, record.longitude);
                }, 100);
            }
        }

        function populateModalData(record) {
            const dataPanel = document.getElementById('modalDataContent');
            
            const displayLocation = record.districtCity || record.district || 'Unknown';
            
            dataPanel.innerHTML = `
                <div class="data-grid">
                    <div>
                        <div class="section-title">
                            <i class="fa-solid fa-info-circle"></i> Property Information
                        </div>
                        <div class="data-group">
                            <span class="data-label">Property ID</span>
                            <span class="data-value">${record.propertyId}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Property Name</span>
                            <span class="data-value">${record.propertyName}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Registration Type</span>
                            <span class="data-value">${record.registrationType}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Block / Plot</span>
                            <span class="data-value">Block ${record.blockNumber || 'N/A'} / Plot ${record.plotNumber || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div>
                        <div class="section-title">
                            <i class="fa-solid fa-map-pin"></i> Location Hierarchy
                        </div>
                        <div class="data-group">
                            <span class="data-label">District/City</span>
                            <span class="data-value">${displayLocation}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Subcounty</span>
                            <span class="data-value">${record.subcounty || 'N/A'}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Parish</span>
                            <span class="data-value">${record.parish || 'N/A'}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Village</span>
                            <span class="data-value">${record.village || 'N/A'}</span>
                        </div>
                    </div>
                </div>

                <div class="section-title">
                    <i class="fa-solid fa-chart-line"></i> Valuation Details
                </div>
                <div class="data-grid">
                    <div>
                        <div class="data-group">
                            <span class="data-label">Total Price</span>
                            <span class="data-value">Ugx ${Number(record.price).toLocaleString()}</span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Size</span>
                            <span class="data-value">${record.size} Ha</span>
                        </div>
                    </div>
                    <div>
                        <div class="data-group">
                            <span class="data-label">Rate per Hectare</span>
                            <span class="data-value" style="color: var(--accent); font-weight: bold;">
                            Ugx ${Number(record.rate).toLocaleString()}/Ha
                            </span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Rate per Acre</span>
                            <span class="data-value" style="color: var(--info); font-weight: bold;">
                            Ugx ${Number(record.ratePerAcre).toLocaleString()}/Acre
                            </span>
                        </div>
                        <div class="data-group">
                            <span class="data-label">Land Use</span>
                            <span class="data-value">${record.landUse || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                
                ${record.description ? `
                <div class="section-title">
                    <i class="fa-solid fa-align-left"></i> Property Description
                </div>
                <div class="description-box">
                    ${record.description}
                </div>
                ` : ''}
                
                <div class="section-title">
                    <i class="fa-solid fa-database"></i> Data Source & Location Information
                </div>
                <div class="data-grid">
                    <div class="data-group">
                        <span class="data-label">Data Source</span>
                        <span class="data-value">${record.dataSource || 'Not specified'}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">Coordinates</span>
                        <span class="data-value">${record.coordinates || 'Not available'}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">Location Mode</span>
                        <span class="data-value">${record.locationMode || 'Not specified'}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">Position Source</span>
                        <span class="data-value">${record.positionSource || 'Not specified'}</span>
                    </div>
                    ${record.gpsAccuracy ? `
                    <div class="data-group">
                        <span class="data-label">GPS Accuracy</span>
                        <span class="data-value">${record.gpsAccuracy} meters</span>
                    </div>
                    ` : ''}
                </div>
                
                <div class="section-title">
                    <i class="fa-solid fa-user-tie"></i> Officer Information
                </div>
                <div class="data-grid">
                    <div class="data-group">
                        <span class="data-label">Officer Name</span>
                        <span class="data-value">${record.officerName}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">Officer Email</span>
                        <span class="data-value">${record.officerEmail || 'Not provided'}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">User ID</span>
                        <span class="data-value">${record.userId || 'Not provided'}</span>
                    </div>
                    <div class="data-group">
                        <span class="data-label">Submission Date</span>
                        <span class="data-value">${record.formattedDate || formatDate(record.submissionDate)}</span>
                    </div>
                </div>
                
                ${(record.reviewedBy || record.rejectionReason || record.approvalNotes) ? `
                <div class="section-title">
                    <i class="fa-solid fa-clipboard-check"></i> Review Status
                </div>
                <div class="data-grid">
                    ${record.reviewedBy ? `
                    <div class="data-group">
                        <span class="data-label">Reviewed By</span>
                        <span class="data-value">${record.reviewedBy}</span>
                    </div>` : ''}
                    ${record.reviewedAt ? `
                    <div class="data-group">
                        <span class="data-label">Reviewed At</span>
                        <span class="data-value">${formatDate(record.reviewedAt)}</span>
                    </div>` : ''}
                    ${record.rejectionReason ? `
                    <div class="data-group" style="grid-column: span 2;">
                        <span class="data-label">Rejection Reason</span>
                        <span class="data-value" style="color: var(--danger);">${record.rejectionReason}</span>
                    </div>` : ''}
                    ${record.approvalNotes ? `
                    <div class="data-group" style="grid-column: span 2;">
                        <span class="data-label">Approval Notes</span>
                        <span class="data-value" style="color: var(--success);">${record.approvalNotes}</span>
                    </div>` : ''}
                </div>` : ''}
            `;
        }

        // ============================================
        // LOCATION MAP
        // ============================================
        function initLocationMap(lat, lng) {
            if (!lat || !lng) return;
            
            const latNum = parseFloat(lat);
            const lngNum = parseFloat(lng);
            
            if (isNaN(latNum) || isNaN(lngNum)) return;
            
            if (locationMap) {
                locationMap.remove();
            }
            
            locationMap = L.map('locationMap').setView([latNum, lngNum], 15);
            
            L.tileLayer('https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
            }).addTo(locationMap);
            
            L.marker([latNum, lngNum], {
                icon: L.divIcon({
                    html: `<div style="background: var(--accent); width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(locationMap);
            
            L.circle([latNum, lngNum], {
                color: 'var(--accent)',
                fillColor: 'var(--accent)',
                fillOpacity: 0.2,
                radius: 20
            }).addTo(locationMap);
        }

        function switchEvidenceTab(tabName) {
            document.querySelectorAll('.evidence-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('review-img').style.display = tabName === 'main' ? 'block' : 'none';
            document.getElementById('locationEvidence').style.display = tabName === 'location' ? 'block' : 'none';
            document.getElementById('additionalEvidence').style.display = tabName === 'additional' ? 'block' : 'none';
        }

        function closeModal() {
            document.getElementById('reviewModal').style.display = 'none';
            removeHighlight();
            
            if (locationMap) {
                locationMap.remove();
                locationMap = null;
            }
        }

        // ============================================
        // EDIT MODAL FUNCTIONS (UPDATED with Rate per Acre)
        // ============================================
        function populateEditForm(record) {
            const editBody = document.getElementById('editModalBody');
            
            editBody.innerHTML = `
                <div class="edit-section-title">
                    <i class="fa-solid fa-info-circle"></i> Basic Information
                </div>
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>Property ID</label>
                        <input type="text" id="editPropertyId" value="${record.propertyId || ''}" readonly class="edit-input" style="background:#eee;">
                    </div>
                    <div class="edit-form-group">
                        <label>Property Name</label>
                        <input type="text" id="editPropertyName" value="${record.propertyName || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Registration Type</label>
                        <select id="editRegistrationType" class="edit-input">
                            <option value="titled" ${record.registrationType === 'titled' ? 'selected' : ''}>Titled</option>
                            <option value="untitled" ${record.registrationType === 'untitled' ? 'selected' : ''}>Untitled</option>
                        </select>
                    </div>
                </div>
                
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>Block Number</label>
                        <input type="text" id="editBlockNumber" value="${record.blockNumber || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Plot Number</label>
                        <input type="text" id="editPlotNumber" value="${record.plotNumber || ''}" class="edit-input">
                    </div>
                </div>

                <div class="edit-section-title">
                    <i class="fa-solid fa-map-pin"></i> Location Hierarchy
                </div>
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>District/City</label>
                        <input type="text" id="editDistrictCity" value="${record.districtCity || record.district || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Subcounty</label>
                        <input type="text" id="editSubcounty" value="${record.subcounty || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Parish</label>
                        <input type="text" id="editParish" value="${record.parish || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Village</label>
                        <input type="text" id="editVillage" value="${record.village || ''}" class="edit-input">
                    </div>
                </div>
                
                <div class="edit-section-title">
                    <i class="fa-solid fa-align-left"></i> Property Description
                </div>
                <div class="edit-form-group" style="grid-column: span 2;">
                    <label>Description</label>
                    <textarea id="editDescription" class="edit-input" rows="3">${record.description || ''}</textarea>
                </div>
                
                <div class="edit-section-title">
                    <i class="fa-solid fa-chart-line"></i> Valuation & Data
                </div>
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>Total Price (Ugx)</label>
                        <input type="number" id="editPrice" value="${record.price || 0}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Size (Ha)</label>
                        <input type="number" step="0.01" id="editSize" value="${record.size || 0}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Land Use</label>
                        <input type="text" id="editLandUse" value="${record.landUse || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Data Source</label>
                        <select id="editDataSource" class="edit-input">
                            <option value="field_survey" ${record.dataSource === 'field_survey' ? 'selected' : ''}>Field Survey</option>
                            <option value="government_records" ${record.dataSource === 'government_records' ? 'selected' : ''}>Government Records</option>
                            <option value="owner_report" ${record.dataSource === 'owner_report' ? 'selected' : ''}>Owner Report</option>
                            <option value="agent_report" ${record.dataSource === 'agent_report' ? 'selected' : ''}>Agent Report</option>
                        </select>
                    </div>
                </div>
                
                <div class="edit-section-title">
                    <i class="fa-solid fa-location-dot"></i> Location Information
                </div>
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>Latitude</label>
                        <input type="number" step="0.000001" id="editLatitude" value="${record.latitude || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Longitude</label>
                        <input type="number" step="0.000001" id="editLongitude" value="${record.longitude || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Position Source</label>
                        <select id="editPositionSource" class="edit-input">
                            <option value="gps" ${record.positionSource === 'gps' ? 'selected' : ''}>GPS</option>
                            <option value="manual" ${record.positionSource === 'manual' ? 'selected' : ''}>Manual</option>
                            <option value="estimated" ${record.positionSource === 'estimated' ? 'selected' : ''}>Estimated</option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label>GPS Accuracy (meters)</label>
                        <input type="number" step="0.1" id="editGpsAccuracy" value="${record.gpsAccuracy || ''}" class="edit-input">
                    </div>
                </div>
                
                <div class="edit-section-title">
                    <i class="fa-solid fa-user-tie"></i> Officer Information
                </div>
                <div class="edit-form-grid">
                    <div class="edit-form-group">
                        <label>Officer Name</label>
                        <input type="text" id="editOfficerName" value="${record.officerName || ''}" class="edit-input">
                    </div>
                    <div class="edit-form-group">
                        <label>Officer Email</label>
                        <input type="email" id="editOfficerEmail" value="${record.officerEmail || ''}" class="edit-input">
                    </div>
                </div>
            `;
        }

        async function saveEditedData() {
            try {
                const recordRef = db.collection('properties').doc(currentReviewId);
                
                const price = parseFloat(document.getElementById('editPrice').value) || 0;
                const size = parseFloat(document.getElementById('editSize').value) || 1;
                const rate = size > 0 ? price / size : 0;
                
                const districtCity = document.getElementById('editDistrictCity').value;
                
                const updatedData = {
                    propertyId: document.getElementById('editPropertyId').value,
                    propertyName: document.getElementById('editPropertyName').value,
                    registrationType: document.getElementById('editRegistrationType').value,
                    blockNumber: document.getElementById('editBlockNumber').value,
                    plotNumber: document.getElementById('editPlotNumber').value,
                    districtCity: districtCity,
                    district: districtCity,
                    subcounty: document.getElementById('editSubcounty').value,
                    parish: document.getElementById('editParish').value,
                    village: document.getElementById('editVillage').value,
                    description: document.getElementById('editDescription').value,
                    dataSource: document.getElementById('editDataSource').value,
                    landUse: document.getElementById('editLandUse').value,
                    price: price,
                    size: size,
                    rate: rate,
                    latitude: document.getElementById('editLatitude').value,
                    longitude: document.getElementById('editLongitude').value,
                    coordinates: `${document.getElementById('editLatitude').value || ''}, ${document.getElementById('editLongitude').value || ''}`,
                    positionSource: document.getElementById('editPositionSource').value,
                    gpsAccuracy: document.getElementById('editGpsAccuracy').value || null,
                    officerName: document.getElementById('editOfficerName').value,
                    officerEmail: document.getElementById('editOfficerEmail').value,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    lastEditedBy: currentUser.email,
                    edited: true
                };
                
                await recordRef.update(updatedData);
                
                const recordIndex = allRecords.findIndex(r => r.firebaseId === currentReviewId);
                if (recordIndex !== -1) {
                    allRecords[recordIndex] = {
                        ...allRecords[recordIndex],
                        ...updatedData,
                        ratePerAcre: rate / 2.47105 // Recalculate rate per acre
                    };
                    
                    renderPropertyListItem(currentReviewId, allRecords[recordIndex]);
                    
                    const marker = allMarkers.get(currentReviewId);
                    if (marker) {
                        markersGroup.removeLayer(marker);
                        allMarkers.delete(currentReviewId);
                    }
                    addPropertyToCluster(currentReviewId, allRecords[recordIndex]);
                }
                
                showNotification("Property data updated successfully", "success");
                closeEditModal();
                
                if (document.getElementById('reviewModal').style.display === 'flex') {
                    openReview(currentReviewId);
                }
                
            } catch (error) {
                console.error("Error saving edited data:", error);
                showNotification(`Error: ${error.message}`, "danger");
            }
        }

        function openEditModal() {
            const record = allRecords.find(r => r.firebaseId === currentReviewId);
            if (!record) return;
            
            editFormData = { ...record };
            
            document.getElementById('editModalIdLabel').textContent = `Edit: ${record.propertyId || 'Unknown ID'}`;
            
            const status = record.validationStatus || record.status || 'pending';
            const statusBadge = document.getElementById('editModalStatusBadge');
            statusBadge.textContent = status;
            statusBadge.className = `status-badge status-${status}`;
            
            const dateStr = formatDate(record.submissionDate);
            document.getElementById('editModalTimestamp').textContent = `Submitted: ${dateStr}`;
            
            populateEditForm(record);
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // ============================================
        // APPROVAL FUNCTIONS
        // ============================================
        function showApprovalDialog() {
            const record = allRecords.find(r => r.firebaseId === currentReviewId);
            if (!record) return;
            
            document.getElementById('approvalDialogPropertyInfo').textContent = 
                `Property: ${record.propertyId || 'Unknown'} - ${record.propertyName || 'No Name'}`;
            
            document.getElementById('approverName').value = currentUser ? currentUser.email.split('@')[0] : '';
            document.getElementById('approvalNotes').value = '';
            
            document.getElementById('approvalDialog').style.display = 'flex';
        }

        function closeApprovalDialog() {
            document.getElementById('approvalDialog').style.display = 'none';
        }

        async function confirmApproval() {
            const approverName = document.getElementById('approverName').value;
            const approvalNotes = document.getElementById('approvalNotes').value;
            
            if (!approverName.trim()) {
                showNotification("Please enter your name as approver", "warning");
                return;
            }
            
            try {
                const recordRef = db.collection('properties').doc(currentReviewId);
                const updateData = {
                    validationStatus: 'approved',
                    status: 'approved',
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedBy: approverName,
                    approvalNotes: approvalNotes || '',
                    approvalDate: new Date().toISOString()
                };
                
                await recordRef.update(updateData);
                
                const recordIndex = allRecords.findIndex(r => r.firebaseId === currentReviewId);
                if (recordIndex !== -1) {
                    allRecords[recordIndex].validationStatus = 'approved';
                    allRecords[recordIndex].status = 'approved';
                    allRecords[recordIndex].reviewedAt = new Date();
                    allRecords[recordIndex].reviewedBy = approverName;
                    allRecords[recordIndex].approvalNotes = approvalNotes;
                }
                
                const record = allRecords.find(r => r.firebaseId === currentReviewId);
                if (record) {
                    renderPropertyListItem(currentReviewId, record);
                    
                    const marker = allMarkers.get(currentReviewId);
                    if (marker) {
                        markersGroup.removeLayer(marker);
                        allMarkers.delete(currentReviewId);
                    }
                    addPropertyToCluster(currentReviewId, record);
                }
                
                if (record && record.officerEmail) {
                    await db.collection('notifications').add({
                        recipientEmail: record.officerEmail,
                        propertyId: record.propertyId || currentReviewId,
                        type: 'approval',
                        status: 'approved',
                        message: `Your property submission "${record.propertyId || 'Unknown'}" has been approved by ${approverName}. ${approvalNotes ? 'Notes: ' + approvalNotes : ''}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        adminEmail: currentUser ? currentUser.email : ''
                    });
                    
                    console.log("Approval notification sent to:", record.officerEmail);
                }
                
                createAdminNotification({
                    title: 'Property Approved',
                    message: `Property ${record?.propertyId || currentReviewId} has been approved by ${approverName}.`,
                    type: 'approval',
                    propertyId: record?.propertyId,
                    recipientEmail: currentUser ? currentUser.email : '',
                    showToast: true
                });
                
                showNotification("Property approved successfully", "success");
                updateStats();
                updateAnalyticsView();
                closeApprovalDialog();
                closeModal();
                
            } catch (error) {
                console.error("Error approving property:", error);
                showNotification(`Error: ${error.message}`, "danger");
            }
        }

        // ============================================
        // REJECTION FUNCTIONS
        // ============================================
        function showRejectionDialog() {
            const record = allRecords.find(r => r.firebaseId === currentReviewId);
            if (!record) return;
            
            document.getElementById('dialogPropertyInfo').textContent = 
                `Property: ${record.propertyId || 'Unknown'} - ${record.propertyName || 'No Name'}`;
            
            document.getElementById('reviewerName').value = currentUser ? currentUser.email.split('@')[0] : '';
            document.getElementById('rejectionFeedback').value = '';
            document.getElementById('collectorEmail').textContent = record.officerEmail || 'Unknown';
            
            document.getElementById('rejectionDialog').style.display = 'flex';
        }

        function closeRejectionDialog() {
            document.getElementById('rejectionDialog').style.display = 'none';
        }

        function useTemplate(templateKey) {
            const feedbackTextarea = document.getElementById('rejectionFeedback');
            if (feedbackTemplates[templateKey]) {
                feedbackTextarea.value = feedbackTemplates[templateKey];
                showNotification(`Template "${templateKey.replace('_', ' ')}" applied`, "info");
            }
        }

        async function confirmRejection() {
            const feedback = document.getElementById('rejectionFeedback').value;
            const reviewerName = document.getElementById('reviewerName').value;
            
            if (!feedback.trim()) {
                showNotification("Please provide rejection feedback", "warning");
                return;
            }
            
            if (!reviewerName.trim()) {
                showNotification("Please enter your name as reviewer", "warning");
                return;
            }
            
            try {
                const recordRef = db.collection('properties').doc(currentReviewId);
                const updateData = {
                    validationStatus: 'rejected',
                    status: 'rejected',
                    reviewedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    reviewedBy: reviewerName,
                    rejectionFeedback: feedback,
                    rejectionReason: feedback,
                    rejectionDate: new Date().toISOString()
                };
                
                await recordRef.update(updateData);
                
                const recordIndex = allRecords.findIndex(r => r.firebaseId === currentReviewId);
                if (recordIndex !== -1) {
                    allRecords[recordIndex].validationStatus = 'rejected';
                    allRecords[recordIndex].status = 'rejected';
                    allRecords[recordIndex].reviewedAt = new Date();
                    allRecords[recordIndex].reviewedBy = reviewerName;
                    allRecords[recordIndex].rejectionFeedback = feedback;
                }
                
                const record = allRecords.find(r => r.firebaseId === currentReviewId);
                if (record) {
                    renderPropertyListItem(currentReviewId, record);
                    
                    const marker = allMarkers.get(currentReviewId);
                    if (marker) {
                        markersGroup.removeLayer(marker);
                        allMarkers.delete(currentReviewId);
                    }
                    addPropertyToCluster(currentReviewId, record);
                }
                
                if (record && record.officerEmail) {
                    await db.collection('notifications').add({
                        recipientEmail: record.officerEmail,
                        propertyId: record.propertyId || currentReviewId,
                        type: 'rejection',
                        status: 'rejected',
                        message: `Your property submission "${record.propertyId || 'Unknown'}" has been rejected by ${reviewerName}. Reason: ${feedback}`,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        read: false,
                        adminEmail: currentUser ? currentUser.email : ''
                    });
                    
                    console.log("Rejection notification sent to:", record.officerEmail);
                }
                
                createAdminNotification({
                    title: 'Property Rejected',
                    message: `Property ${record?.propertyId || currentReviewId} has been rejected by ${reviewerName}.`,
                    type: 'rejection',
                    propertyId: record?.propertyId,
                    recipientEmail: currentUser ? currentUser.email : '',
                    showToast: true
                });
                
                showNotification("Property rejected successfully", "success");
                updateStats();
                updateAnalyticsView();
                closeRejectionDialog();
                closeModal();
                
            } catch (error) {
                console.error("Error rejecting property:", error);
                showNotification(`Error: ${error.message}`, "danger");
            }
        }

        // ============================================
        // STATISTICS FUNCTIONS
        // ============================================
        function updateStats() {
            const total = allRecords.length;
            const pending = allRecords.filter(r => (r.validationStatus || r.status) === 'pending').length;
            const approved = allRecords.filter(r => (r.validationStatus || r.status) === 'approved').length;
            const rejected = allRecords.filter(r => (r.validationStatus || r.status) === 'rejected').length;
            
            document.getElementById('totalSubmissions').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
            
            const newCount = newSubmissions.length;
            if (newCount > 0) {
                document.getElementById('newSubmissionsCount').style.display = 'block';
                document.getElementById('newCount').textContent = newCount;
                document.getElementById('newSubmissionsBadge').textContent = newCount;
                document.getElementById('newSubmissionsBadge').style.display = 'flex';
            } else {
                document.getElementById('newSubmissionsCount').style.display = 'none';
                document.getElementById('newSubmissionsBadge').style.display = 'none';
            }
        }

        // ============================================
        // ENHANCED ANALYTICS FUNCTIONS
        // ============================================
        function switchAnalyticsTab(tab) {
            currentAnalyticsTab = tab;
            document.querySelectorAll('.analytics-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update all visible sections based on selected tab
            updateAnalyticsView();
        }

        function switchAnalyticsSubTab(subTab) {
            currentAnalyticsSubTab = subTab;
            document.querySelectorAll('.analytics-sub-tab').forEach(t => {
                t.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.analytics-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(subTab + 'Section').classList.add('active');
            
            // Update the visible section with appropriate data
            updateAnalyticsView();
        }

        function updateAnalyticsView() {
            updateSummaryCards();
            updateStaffPerformance();
            
            // Update overview tables
            switch(currentAnalyticsTab) {
                case 'weekly':
                    updateWeeklyAnalytics();
                    break;
                case 'monthly':
                    updateMonthlyAnalytics();
                    break;
                case 'quarterly':
                    updateQuarterlyAnalytics();
                    break;
                case 'annually':
                    updateAnnuallyAnalytics();
                    break;
            }
            
            // Update district analytics
            updateDistrictWeeklyAnalytics();
            updateDistrictMonthlyAnalytics();
            updateDistrictQuarterlyAnalytics();
            updateDistrictAnnuallyAnalytics();
            
            // Update parish analytics
            updateParishWeeklyAnalytics();
            updateParishMonthlyAnalytics();
            updateParishQuarterlyAnalytics();
            updateParishAnnuallyAnalytics();
            updateTopParishes();
        }

        function updateSummaryCards() {
            const total = allRecords.length;
            const approved = allRecords.filter(r => (r.validationStatus || r.status) === 'approved').length;
            const pending = allRecords.filter(r => (r.validationStatus || r.status) === 'pending').length;
            const totalValue = allRecords.reduce((sum, r) => sum + (parseFloat(r.price) || 0), 0);
            const avgValue = total > 0 ? totalValue / total : 0;
            
            const summaryCards = document.getElementById('summaryCards');
            summaryCards.innerHTML = `
                <div class="summary-card">
                    <h4><i class="fa-solid fa-file-circle-plus"></i> Total Submissions</h4>
                    <div class="summary-value">${total}</div>
                    <div class="summary-label">All time records</div>
                </div>
                <div class="summary-card">
                    <h4><i class="fa-solid fa-check-circle" style="color: var(--success);"></i> Approved</h4>
                    <div class="summary-value">${approved}</div>
                    <div class="summary-label">${total > 0 ? ((approved/total)*100).toFixed(1) : 0}% approval rate</div>
                </div>
                <div class="summary-card">
                    <h4><i class="fa-solid fa-clock" style="color: var(--warning);"></i> Pending</h4>
                    <div class="summary-value">${pending}</div>
                    <div class="summary-label">Awaiting review</div>
                </div>
                <div class="summary-card">
                    <h4><i class="fa-solid fa-money-bill-wave" style="color: var(--accent);"></i> Total Value</h4>
                    <div class="summary-value">Ugx ${Number(totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    <div class="summary-label">Avg: Ugx ${Number(avgValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                </div>
            `;
        }

        function updateStaffPerformance() {
            const staffStats = {};
            
            allRecords.forEach(record => {
                const email = record.officerEmail || 'unknown@email.com';
                const name = record.officerName || 'Unknown';
                
                if (!staffStats[email]) {
                    staffStats[email] = {
                        name: name,
                        email: email,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0
                    };
                }
                
                staffStats[email].total++;
                staffStats[email].totalValue += parseFloat(record.price) || 0;
                staffStats[email].totalSize += parseFloat(record.size) || 0;
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') staffStats[email].approved++;
                else if (status === 'rejected') staffStats[email].rejected++;
                else staffStats[email].pending++;
            });
            
            const body = document.getElementById('staffPerformanceBody');
            body.innerHTML = Object.values(staffStats)
                .sort((a, b) => b.total - a.total)
                .map(staff => {
                    const avgRate = staff.totalSize > 0 ? staff.totalValue / staff.totalSize : 0;
                    return `
                    <tr>
                        <td>${staff.name}</td>
                        <td>${staff.email}</td>
                        <td>${staff.total}</td>
                        <td>${staff.pending}</td>
                        <td>${staff.approved}</td>
                        <td>${staff.rejected}</td>
                        <td>${staff.total > 0 ? ((staff.approved/staff.total)*100).toFixed(1) + '%' : '0%'}</td>
                        <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                        <td>Ugx ${Number(staff.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                    </tr>
                `}).join('');
        }

        function updateWeeklyAnalytics() {
            const weeklyData = {};
            const now = new Date();
            
            // Get date 52 weeks ago
            const yearAgo = new Date(now);
            yearAgo.setDate(yearAgo.getDate() - 364);
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date || date < yearAgo) return;
                
                // Get week number
                const startOfYear = new Date(date.getFullYear(), 0, 1);
                const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
                const weekNum = Math.ceil((days + startOfYear.getDay() + 1) / 7);
                const weekKey = `${date.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
                
                if (!weeklyData[weekKey]) {
                    const weekStart = new Date(date);
                    weekStart.setDate(date.getDate() - date.getDay() + 1);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    
                    weeklyData[weekKey] = {
                        week: weekKey,
                        startDate: weekStart,
                        endDate: weekEnd,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set(),
                        districts: new Set()
                    };
                }
                
                const stat = weeklyData[weekKey];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                if (record.districtCity || record.district) {
                    stat.districts.add(record.districtCity || record.district);
                }
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('weeklyBody');
            body.innerHTML = Object.values(weeklyData)
                .sort((a, b) => b.week.localeCompare(a.week))
                .slice(0, 52)
                .map(week => {
                    const avgRate = week.totalSize > 0 ? week.totalValue / week.totalSize : 0;
                    return `
                    <tr>
                        <td>${week.week}</td>
                        <td>${week.startDate.toLocaleDateString()}</td>
                        <td>${week.endDate.toLocaleDateString()}</td>
                        <td>${week.total}</td>
                        <td>${week.pending}</td>
                        <td>${week.approved}</td>
                        <td>${week.rejected}</td>
                        <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                        <td>Ugx ${Number(week.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>${week.officers.size}</td>
                        <td>${week.districts.size}</td>
                    </tr>
                `}).join('');
        }

        function updateMonthlyAnalytics() {
            const monthlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        month: date.toLocaleString('default', { month: 'long' }),
                        year: date.getFullYear(),
                        key: monthKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set(),
                        districts: new Set()
                    };
                }
                
                const stat = monthlyData[monthKey];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                if (record.districtCity || record.district) {
                    stat.districts.add(record.districtCity || record.district);
                }
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('monthlyBody');
            body.innerHTML = Object.values(monthlyData)
                .sort((a, b) => b.key.localeCompare(a.key))
                .map(month => {
                    const avgRate = month.totalSize > 0 ? month.totalValue / month.totalSize : 0;
                    return `
                    <tr>
                        <td>${month.month}</td>
                        <td>${month.year}</td>
                        <td>${month.total}</td>
                        <td>${month.pending}</td>
                        <td>${month.approved}</td>
                        <td>${month.rejected}</td>
                        <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                        <td>Ugx ${Number(month.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td> 
                        <td>${month.officers.size}</td>
                        <td>${month.districts.size}</td>
                    </tr>
                `}).join('');
        }

        function updateQuarterlyAnalytics() {
            const quarterlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                const quarterKey = `${date.getFullYear()}-Q${quarter}`;
                
                if (!quarterlyData[quarterKey]) {
                    quarterlyData[quarterKey] = {
                        quarter: `Q${quarter}`,
                        year: date.getFullYear(),
                        key: quarterKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set(),
                        districts: new Set()
                    };
                }
                
                const stat = quarterlyData[quarterKey];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                if (record.districtCity || record.district) {
                    stat.districts.add(record.districtCity || record.district);
                }
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('quarterlyBody');
            body.innerHTML = Object.values(quarterlyData)
                .sort((a, b) => b.key.localeCompare(a.key))
                .map(quarter => {
                    const avgRate = quarter.totalSize > 0 ? quarter.totalValue / quarter.totalSize : 0;
                    return `
                    <tr>
                        <td>${quarter.quarter}</td>
                        <td>${quarter.year}</td>
                        <td>${quarter.total}</td>
                        <td>${quarter.pending}</td>
                        <td>${quarter.approved}</td>
                        <td>${quarter.rejected}</td>
                        <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                        <td>Ugx ${Number(quarter.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>${quarter.officers.size}</td>
                        <td>${quarter.districts.size}</td>
                    </tr>
                `}).join('');
        }

        function updateAnnuallyAnalytics() {
            const annualData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const year = date.getFullYear();
                
                if (!annualData[year]) {
                    annualData[year] = {
                        year: year,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set(),
                        districts: new Set()
                    };
                }
                
                const stat = annualData[year];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                if (record.districtCity || record.district) {
                    stat.districts.add(record.districtCity || record.district);
                }
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('annuallyBody');
            body.innerHTML = Object.values(annualData)
                .sort((a, b) => b.year - a.year)
                .map(year => {
                    const avgRate = year.totalSize > 0 ? year.totalValue / year.totalSize : 0;
                    return `
                    <tr>
                        <td>${year.year}</td>
                        <td>${year.total}</td>
                        <td>${year.pending}</td>
                        <td>${year.approved}</td>
                        <td>${year.rejected}</td>
                        <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                        <td>Ugx ${Number(year.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                        <td>${year.officers.size}</td>
                        <td>${year.districts.size}</td>
                    </tr>
                `}).join('');
        }

        // ============================================
        // DISTRICT ANALYTICS FUNCTIONS
        // ============================================
        function updateDistrictWeeklyAnalytics() {
            const districtWeeklyData = {};
            const now = new Date();
            const yearAgo = new Date(now);
            yearAgo.setDate(yearAgo.getDate() - 364);
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date || date < yearAgo) return;
                
                const district = record.districtCity || record.district || 'Unknown';
                const weekKey = getWeekKey(date);
                
                const key = `${district}-${weekKey}`;
                
                if (!districtWeeklyData[key]) {
                    districtWeeklyData[key] = {
                        district: district,
                        week: weekKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = districtWeeklyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('districtWeeklyBody');
            body.innerHTML = Object.values(districtWeeklyData)
                .sort((a, b) => b.week.localeCompare(a.week) || a.district.localeCompare(b.district))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.district}</td>
                            <td>${stat.week}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateDistrictMonthlyAnalytics() {
            const districtMonthlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const district = record.districtCity || record.district || 'Unknown';
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const key = `${district}-${monthKey}`;
                
                if (!districtMonthlyData[key]) {
                    districtMonthlyData[key] = {
                        district: district,
                        month: date.toLocaleString('default', { month: 'long' }),
                        year: date.getFullYear(),
                        monthKey: monthKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = districtMonthlyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('districtMonthlyBody');
            body.innerHTML = Object.values(districtMonthlyData)
                .sort((a, b) => b.monthKey.localeCompare(a.monthKey) || a.district.localeCompare(b.district))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.district}</td>
                            <td>${stat.month}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateDistrictQuarterlyAnalytics() {
            const districtQuarterlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const district = record.districtCity || record.district || 'Unknown';
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                const quarterKey = `${date.getFullYear()}-Q${quarter}`;
                
                const key = `${district}-${quarterKey}`;
                
                if (!districtQuarterlyData[key]) {
                    districtQuarterlyData[key] = {
                        district: district,
                        quarter: `Q${quarter}`,
                        year: date.getFullYear(),
                        quarterKey: quarterKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = districtQuarterlyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('districtQuarterlyBody');
            body.innerHTML = Object.values(districtQuarterlyData)
                .sort((a, b) => b.quarterKey.localeCompare(a.quarterKey) || a.district.localeCompare(b.district))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.district}</td>
                            <td>${stat.quarter}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateDistrictAnnuallyAnalytics() {
            const districtAnnualData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const district = record.districtCity || record.district || 'Unknown';
                const year = date.getFullYear();
                
                const key = `${district}-${year}`;
                
                if (!districtAnnualData[key]) {
                    districtAnnualData[key] = {
                        district: district,
                        year: year,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = districtAnnualData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('districtAnnuallyBody');
            body.innerHTML = Object.values(districtAnnualData)
                .sort((a, b) => b.year - a.year || a.district.localeCompare(b.district))
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.district}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        // ============================================
        // PARISH ANALYTICS FUNCTIONS
        // ============================================
        function getWeekKey(date) {
            const startOfYear = new Date(date.getFullYear(), 0, 1);
            const days = Math.floor((date - startOfYear) / (24 * 60 * 60 * 1000));
            const weekNum = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            return `${date.getFullYear()}-W${String(weekNum).padStart(2, '0')}`;
        }

        function updateParishWeeklyAnalytics() {
            const parishWeeklyData = {};
            const now = new Date();
            const yearAgo = new Date(now);
            yearAgo.setDate(yearAgo.getDate() - 364);
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date || date < yearAgo) return;
                
                const parish = record.parish || 'Unknown';
                const district = record.districtCity || record.district || 'Unknown';
                const weekKey = getWeekKey(date);
                
                const key = `${parish}-${district}-${weekKey}`;
                
                if (!parishWeeklyData[key]) {
                    parishWeeklyData[key] = {
                        parish: parish,
                        district: district,
                        week: weekKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = parishWeeklyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('parishWeeklyBody');
            body.innerHTML = Object.values(parishWeeklyData)
                .sort((a, b) => b.week.localeCompare(a.week) || a.district.localeCompare(b.district) || a.parish.localeCompare(b.parish))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.parish}</td>
                            <td>${stat.district}</td>
                            <td>${stat.week}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateParishMonthlyAnalytics() {
            const parishMonthlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const parish = record.parish || 'Unknown';
                const district = record.districtCity || record.district || 'Unknown';
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                const key = `${parish}-${district}-${monthKey}`;
                
                if (!parishMonthlyData[key]) {
                    parishMonthlyData[key] = {
                        parish: parish,
                        district: district,
                        month: date.toLocaleString('default', { month: 'long' }),
                        year: date.getFullYear(),
                        monthKey: monthKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = parishMonthlyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('parishMonthlyBody');
            body.innerHTML = Object.values(parishMonthlyData)
                .sort((a, b) => b.monthKey.localeCompare(a.monthKey) || a.district.localeCompare(b.district) || a.parish.localeCompare(b.parish))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.parish}</td>
                            <td>${stat.district}</td>
                            <td>${stat.month}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateParishQuarterlyAnalytics() {
            const parishQuarterlyData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const parish = record.parish || 'Unknown';
                const district = record.districtCity || record.district || 'Unknown';
                const quarter = Math.floor(date.getMonth() / 3) + 1;
                const quarterKey = `${date.getFullYear()}-Q${quarter}`;
                
                const key = `${parish}-${district}-${quarterKey}`;
                
                if (!parishQuarterlyData[key]) {
                    parishQuarterlyData[key] = {
                        parish: parish,
                        district: district,
                        quarter: `Q${quarter}`,
                        year: date.getFullYear(),
                        quarterKey: quarterKey,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = parishQuarterlyData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('parishQuarterlyBody');
            body.innerHTML = Object.values(parishQuarterlyData)
                .sort((a, b) => b.quarterKey.localeCompare(a.quarterKey) || a.district.localeCompare(b.district) || a.parish.localeCompare(b.parish))
                .slice(0, 200)
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.parish}</td>
                            <td>${stat.district}</td>
                            <td>${stat.quarter}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateParishAnnuallyAnalytics() {
            const parishAnnualData = {};
            
            allRecords.forEach(record => {
                const date = parseFirestoreDate(record.submissionDate);
                if (!date) return;
                
                const parish = record.parish || 'Unknown';
                const district = record.districtCity || record.district || 'Unknown';
                const year = date.getFullYear();
                
                const key = `${parish}-${district}-${year}`;
                
                if (!parishAnnualData[key]) {
                    parishAnnualData[key] = {
                        parish: parish,
                        district: district,
                        year: year,
                        total: 0,
                        pending: 0,
                        approved: 0,
                        rejected: 0,
                        totalValue: 0,
                        totalSize: 0,
                        officers: new Set()
                    };
                }
                
                const stat = parishAnnualData[key];
                stat.total++;
                stat.totalValue += parseFloat(record.price) || 0;
                stat.totalSize += parseFloat(record.size) || 0;
                
                if (record.officerEmail) stat.officers.add(record.officerEmail);
                
                const status = record.validationStatus || record.status || 'pending';
                if (status === 'approved') stat.approved++;
                else if (status === 'rejected') stat.rejected++;
                else stat.pending++;
            });
            
            const body = document.getElementById('parishAnnuallyBody');
            body.innerHTML = Object.values(parishAnnualData)
                .sort((a, b) => b.year - a.year || a.district.localeCompare(b.district) || a.parish.localeCompare(b.parish))
                .map(stat => {
                    const avgRate = stat.totalSize > 0 ? stat.totalValue / stat.totalSize : 0;
                    const approvalRate = stat.total > 0 ? (stat.approved / stat.total * 100).toFixed(1) : 0;
                    return `
                        <tr>
                            <td>${stat.parish}</td>
                            <td>${stat.district}</td>
                            <td>${stat.year}</td>
                            <td>${stat.total}</td>
                            <td>${stat.pending}</td>
                            <td>${stat.approved}</td>
                            <td>${stat.rejected}</td>
                            <td>${approvalRate}%</td>
                            <td>Ugx ${Number(avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</td>
                            <td>Ugx ${Number(stat.totalValue).toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                            <td>${stat.officers.size}</td>
                        </tr>
                    `;
                }).join('');
        }

        function updateTopParishes() {
            const parishStats = {};
            
            allRecords.forEach(record => {
                const parish = record.parish || 'Unknown';
                const district = record.districtCity || record.district || 'Unknown';
                
                if (!parishStats[parish]) {
                    parishStats[parish] = {
                        name: parish,
                        district: district,
                        total: 0,
                        approved: 0,
                        totalValue: 0,
                        avgRate: 0,
                        totalSize: 0
                    };
                }
                
                parishStats[parish].total++;
                parishStats[parish].totalValue += parseFloat(record.price) || 0;
                parishStats[parish].totalSize += parseFloat(record.size) || 0;
                
                if ((record.validationStatus || record.status) === 'approved') {
                    parishStats[parish].approved++;
                }
            });
            
            // Calculate average rates
            Object.values(parishStats).forEach(parish => {
                parish.avgRate = parish.totalSize > 0 ? parish.totalValue / parish.totalSize : 0;
            });
            
            // Get top 10 parishes by total value
            const topParishes = Object.values(parishStats)
                .sort((a, b) => b.totalValue - a.totalValue)
                .slice(0, 12);
            
            const container = document.getElementById('topParishesContainer');
            container.innerHTML = topParishes.map(parish => `
                <div class="parish-stat-item">
                    <div class="parish-name">${parish.name}</div>
                    <div class="parish-district">${parish.district}</div>
                    <div class="parish-stat-value">Ugx ${Number(parish.avgRate).toLocaleString(undefined, {maximumFractionDigits: 0})}/Ha</div>
                    <div class="parish-stat-label">Avg. Rate</div>
                    <div style="margin-top: 8px; font-size: 0.9rem;">
                        <span class="status-badge status-approved">${parish.approved} approved</span>
                        <span style="margin-left: 5px; color: #7f8c8d;">${parish.total} total</span>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // FILTER FUNCTIONS
        // ============================================
        function updateOfficerFilter() {
            const officerSelect = document.getElementById('officerFilter');
            const districtSelect = document.getElementById('districtFilter');
            const exportOfficerSelect = document.getElementById('exportOfficer');
            const exportDistrictSelect = document.getElementById('exportDistrict');
            
            const officerEmails = [...new Set(allRecords
                .map(r => r.officerEmail)
                .filter(email => email && email.trim() !== ''))].sort();
            
            while (officerSelect.options.length > 1) {
                officerSelect.remove(1);
            }
            while (exportOfficerSelect.options.length > 1) {
                exportOfficerSelect.remove(1);
            }
            
            officerEmails.forEach(email => {
                const option = document.createElement('option');
                option.value = email;
                option.textContent = email;
                officerSelect.appendChild(option);
                
                const exportOption = option.cloneNode(true);
                exportOfficerSelect.appendChild(exportOption);
            });
            
            const districts = [...new Set(allRecords
                .map(r => r.districtCity || r.district)
                .filter(d => d && d.trim() !== ''))].sort();
            
            while (districtSelect.options.length > 1) {
                districtSelect.remove(1);
            }
            while (exportDistrictSelect.options.length > 1) {
                exportDistrictSelect.remove(1);
            }
            
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
                
                const exportOption = option.cloneNode(true);
                exportDistrictSelect.appendChild(exportOption);
            });
        }

        function filterList() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const officerFilter = document.getElementById('officerFilter').value;
            const districtFilter = document.getElementById('districtFilter').value;
            
            const container = document.getElementById('recordList');
            const items = container.querySelectorAll('.list-item');
            
            let visibleCount = 0;
            
            items.forEach(item => {
                const id = item.dataset.id;
                const record = allRecords.find(r => r.firebaseId === id);
                if (!record) {
                    item.style.display = 'none';
                    return;
                }
                
                const displayLocation = record.districtCity || record.district || '';
                
                const matchesSearch = !searchTerm || 
                    (record.propertyId && record.propertyId.toLowerCase().includes(searchTerm)) ||
                    (record.propertyName && record.propertyName.toLowerCase().includes(searchTerm)) ||
                    (record.officerName && record.officerName.toLowerCase().includes(searchTerm)) ||
                    (displayLocation.toLowerCase().includes(searchTerm));
                
                const matchesStatus = statusFilter === 'all' || 
                    (record.validationStatus === statusFilter) || 
                    (record.status === statusFilter);
                
                let matchesDate = true;
                if (dateFrom || dateTo) {
                    const recordDate = parseFirestoreDate(record.submissionDate);
                    if (recordDate) {
                        if (dateFrom) {
                            const fromDate = new Date(dateFrom);
                            fromDate.setHours(0, 0, 0, 0);
                            if (recordDate < fromDate) matchesDate = false;
                        }
                        if (dateTo) {
                            const toDate = new Date(dateTo);
                            toDate.setHours(23, 59, 59, 999);
                            if (recordDate > toDate) matchesDate = false;
                        }
                    } else {
                        matchesDate = false;
                    }
                }
                
                const matchesOfficer = officerFilter === 'all' || record.officerEmail === officerFilter;
                const matchesDistrict = districtFilter === 'all' || 
                    (record.districtCity === districtFilter) || 
                    (record.district === districtFilter);
                
                const shouldShow = matchesSearch && matchesStatus && matchesDate && matchesOfficer && matchesDistrict;
                item.style.display = shouldShow ? 'block' : 'none';
                
                if (shouldShow) visibleCount++;
            });
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = 'all';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('officerFilter').value = 'all';
            document.getElementById('districtFilter').value = 'all';
            
            filterList();
            showNotification("Filters have been reset", "info");
        }

        // ============================================
        // MAP CONTROL FUNCTIONS
        // ============================================
        function showOnlyPending() {
            document.getElementById('statusFilter').value = 'pending';
            filterList();
            
            const pendingRecords = allRecords.filter(r => (r.validationStatus || r.status) === 'pending');
            if (pendingRecords.length > 0) {
                const bounds = L.latLngBounds([]);
                pendingRecords.forEach(record => {
                    if (record.latitude && record.longitude) {
                        bounds.extend([parseFloat(record.latitude), parseFloat(record.longitude)]);
                    }
                });
                
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            showNotification(`Showing ${pendingRecords.length} pending properties`, "info");
        }

        function showAllOnMap() {
            resetFilters();
            
            if (allRecords.length > 0) {
                const bounds = L.latLngBounds([]);
                allRecords.forEach(record => {
                    if (record.latitude && record.longitude) {
                        bounds.extend([parseFloat(record.latitude), parseFloat(record.longitude)]);
                    }
                });
                
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
        }

        // ============================================
        // AUTHENTICATION FUNCTIONS
        // ============================================
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');
            
            if (!email || !password) {
                loginError.textContent = "Please enter both email and password";
                return;
            }
            
            const originalText = loginButton.innerHTML;
            loginButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> AUTHENTICATING...';
            loginButton.disabled = true;
            loginError.textContent = "";
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showNotification("Login successful", "success");
                
                const rememberMe = document.querySelector('.toggle-switch').classList.contains('active');
                if (rememberMe) {
                    localStorage.setItem('lavmis_admin_email', email);
                    localStorage.setItem('lavmis_admin_password', password);
                    localStorage.setItem('lavmis_remember_me', 'true');
                } else {
                    localStorage.removeItem('lavmis_admin_email');
                    localStorage.removeItem('lavmis_admin_password');
                    localStorage.setItem('lavmis_remember_me', 'false');
                }
                
            } catch (error) {
                console.error("Login error:", error);
                loginError.textContent = `Login failed: ${error.message}`;
                showNotification(`Login failed: ${error.message}`, "danger");
            } finally {
                loginButton.innerHTML = originalText;
                loginButton.disabled = false;
            }
        }

        function toggleRememberMe() {
            const toggle = document.querySelector('.toggle-switch');
            toggle.classList.toggle('active');
        }

        async function logout() {
            if (confirm("Are you sure you want to logout?")) {
                try {
                    await auth.signOut();
                    showNotification("Logged out successfully", "info");
                    
                    if (localStorage.getItem('lavmis_remember_me') !== 'true') {
                        localStorage.removeItem('lavmis_admin_email');
                        localStorage.removeItem('lavmis_admin_password');
                    }
                } catch (error) {
                    console.error("Logout error:", error);
                    showNotification(`Logout error: ${error.message}`, "danger");
                }
            }
        }

        // ============================================
        // VIEW SWITCHING
        // ============================================
        function switchView(viewId, clickedElement) {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (clickedElement) {
                clickedElement.classList.add('active');
            }
            
            document.querySelectorAll('.view-content').forEach(view => {
                view.classList.remove('active');
            });
            
            document.getElementById(viewId).classList.add('active');
            
            if (viewId === 'stats-view') {
                updateAnalyticsView();
            } else if (viewId === 'users-view') {
                loadAdminUsers();
            }
        }

        // ============================================
        // ADMIN NOTIFICATIONS
        // ============================================
        function createAdminNotification(notificationData) {
            const notification = {
                id: Date.now().toString(),
                title: notificationData.title,
                message: notificationData.message,
                type: notificationData.type || 'system',
                propertyId: notificationData.propertyId,
                recipientEmail: notificationData.recipientEmail,
                timestamp: new Date(),
                read: false,
                showToast: notificationData.showToast || false
            };
            
            adminNotifications.unshift(notification);
            
            updateNotificationBadge();
            
            saveNotificationToFirestore(notification);
            
            if (notification.showToast) {
                showNotification(`${notification.title}: ${notification.message}`, 
                    notification.type === 'approval' ? 'success' : 
                    notification.type === 'rejection' ? 'danger' : 'info');
            }
        }

        async function saveNotificationToFirestore(notification) {
            try {
                await db.collection('admin_notifications').add({
                    ...notification,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error("Error saving notification to Firestore:", error);
            }
        }

        function setupAdminNotificationsListener() {
            if (adminNotificationListener) {
                adminNotificationListener();
            }
            
            if (!currentUser) return;
            
            adminNotificationListener = db.collection('admin_notifications')
                .where('recipientEmail', '==', currentUser.email)
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    adminNotifications = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        adminNotifications.push({
                            id: doc.id,
                            ...data,
                            timestamp: data.timestamp?.toDate() || new Date()
                        });
                    });
                    
                    updateNotificationBadge();
                    renderNotificationsPanel();
                }, error => {
                    console.error("Error listening to notifications:", error);
                });
        }

        function updateNotificationBadge() {
            const unreadCount = adminNotifications.filter(n => !n.read).length;
            const badge = document.getElementById('adminNotificationCount');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount.toString();
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function openNotificationsPanel() {
            document.getElementById('adminNotificationsPanel').classList.add('open');
            renderNotificationsPanel();
        }

        function closeNotificationsPanel() {
            document.getElementById('adminNotificationsPanel').classList.remove('open');
        }

        function renderNotificationsPanel() {
            const body = document.getElementById('adminNotificationsBody');
            
            if (adminNotifications.length === 0) {
                body.innerHTML = `
                    <div class="no-notifications">
                        <i class="fa-regular fa-bell-slash"></i>
                        <h4>No Notifications</h4>
                        <p>You're all caught up!</p>
                    </div>
                `;
                return;
            }
            
            body.innerHTML = adminNotifications.map(notification => `
                <div class="notification-item ${notification.read ? 'read' : 'unread'}" 
                     onclick="viewNotification('${notification.id}')">
                    <div class="notification-type ${notification.type}">
                        ${(notification.type || 'system').toUpperCase()}
                    </div>
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        ${notification.title}
                    </div>
                    <div style="font-size: 0.9rem; color: #555;">
                        ${notification.message}
                    </div>
                    <div class="notification-time">
                        <i class="fa-regular fa-clock"></i>
                        ${formatTimeAgo(notification.timestamp)}
                    </div>
                    ${notification.propertyId ? `
                    <div class="notification-actions">
                        <button class="notification-action-btn view" 
                                onclick="viewPropertyFromNotification('${notification.propertyId}'); event.stopPropagation();">
                            <i class="fa-solid fa-eye"></i> View Property
                        </button>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function viewNotification(notificationId) {
            const notification = adminNotifications.find(n => n.id === notificationId);
            if (!notification) return;
            
            markNotificationAsRead(notificationId);
            
            if (notification.propertyId) {
                viewPropertyFromNotification(notification.propertyId);
            }
        }

        async function markNotificationAsRead(notificationId) {
            try {
                await db.collection('admin_notifications').doc(notificationId).update({
                    read: true
                });
                
                const notification = adminNotifications.find(n => n.id === notificationId);
                if (notification) {
                    notification.read = true;
                }
                
                updateNotificationBadge();
                renderNotificationsPanel();
                
            } catch (error) {
                console.error("Error marking notification as read:", error);
            }
        }

        async function markAllNotificationsAsRead() {
            try {
                const batch = db.batch();
                const unreadNotifications = adminNotifications.filter(n => !n.read);
                
                unreadNotifications.forEach(notification => {
                    const ref = db.collection('admin_notifications').doc(notification.id);
                    batch.update(ref, { read: true });
                    notification.read = true;
                });
                
                await batch.commit();
                updateNotificationBadge();
                renderNotificationsPanel();
                showNotification(`Marked ${unreadNotifications.length} notifications as read`, "success");
                
            } catch (error) {
                console.error("Error marking all notifications as read:", error);
                showNotification(`Error: ${error.message}`, "danger");
            }
        }

        function viewPropertyFromNotification(propertyId) {
            const record = allRecords.find(r => r.propertyId === propertyId) || 
                          allRecords.find(r => r.firebaseId === propertyId);
            
            if (record) {
                closeNotificationsPanel();
                currentReviewId = record.firebaseId;
                openReview(record.firebaseId);
                highlightPointOnMap(record.firebaseId);
                highlightListItem(record.firebaseId);
            } else {
                showNotification("Property not found in current data. Try refreshing.", "warning");
            }
        }

        function formatTimeAgo(date) {
            if (!date) return "Unknown";
            
            const now = new Date();
            const diffMs = now - new Date(date);
            const diffMins = Math.round(diffMs / 60000);
            const diffHours = Math.round(diffMs / 3600000);
            const diffDays = Math.round(diffMs / 86400000);
            
            if (diffMins < 1) return "Just now";
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return new Date(date).toLocaleDateString();
        }

        // ============================================
        // USER MANAGEMENT FUNCTIONS
        // ============================================
        async function loadAdminUsers() {
            try {
                const snapshot = await db.collection('authorized_admins').get();
                const body = document.getElementById('adminTableBody');
                
                if (snapshot.empty) {
                    body.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 20px;">No admin users found</td></tr>`;
                    return;
                }
                
                body.innerHTML = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt ? parseFirestoreDate(data.createdAt) : null;
                    const lastActive = data.lastActive ? parseFirestoreDate(data.lastActive) : null;
                    
                    return `
                        <tr>
                            <td>${data.name || 'N/A'}</td>
                            <td>${data.email || 'N/A'}</td>
                            <td><span class="status-badge">${data.role || 'admin'}</span></td>
                            <td>${createdAt ? createdAt.toLocaleDateString() : 'N/A'}</td>
                            <td>${lastActive ? lastActive.toLocaleString() : 'Never'}</td>
                            <td><span class="status-badge status-approved">Active</span></td>
                            <td>
                                <button class="tool-btn" style="padding: 4px 8px; font-size: 0.75rem;" 
                                        onclick="editAdminUser('${doc.id}')">
                                    <i class="fa-solid fa-edit"></i> Edit
                                </button>
                                <button class="tool-btn" style="padding: 4px 8px; font-size: 0.75rem; background: var(--danger); color: white;" 
                                        onclick="deleteAdminUser('${doc.id}', '${data.name}')">
                                    <i class="fa-solid fa-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
            } catch (error) {
                console.error("Error loading admin users:", error);
                showNotification(`Error loading users: ${error.message}`, "danger");
            }
        }

        async function addNewAdmin() {
            const name = document.getElementById('newUserName').value;
            const email = document.getElementById('newUserEmail').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (!name || !email || !password) {
                showNotification("Please fill in all fields", "warning");
                return;
            }
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                
                await db.collection('authorized_admins').add({
                    name: name,
                    email: email,
                    role: role,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser ? currentUser.email : '',
                    active: true
                });
                
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserPassword').value = '';
                
                showNotification(`Admin user ${name} created successfully`, "success");
                loadAdminUsers();
                
            } catch (error) {
                console.error("Error adding admin user:", error);
                showNotification(`Error: ${error.message}`, "danger");
            }
        }

        function showAddUserModal() {
            document.getElementById('newUserName').focus();
        }

        function toggleNotificationSetting(element, settingId) {
            element.classList.toggle('active');
            showNotification(`Notification setting ${settingId} updated`, "info");
        }

        // ============================================
        // EXPORT FUNCTIONS (UPDATED with Rate per Acre)
        // ============================================
        function exportApproved(format) {
            const approvedRecords = allRecords.filter(r => (r.validationStatus || r.status) === 'approved');
            
            if (approvedRecords.length === 0) {
                showNotification("No approved records to export", "warning");
                return;
            }
            
            switch(format) {
                case 'geojson':
                    exportToGeoJSON(approvedRecords);
                    break;
                case 'excel':
                    exportToExcel(approvedRecords);
                    break;
                case 'csv':
                    exportToCSV(approvedRecords);
                    break;
            }
        }

        function exportToGeoJSON(records) {
            const geoJson = {
                type: "FeatureCollection",
                features: records.map(record => ({
                    type: "Feature",
                    geometry: {
                        type: "Point",
                        coordinates: [parseFloat(record.longitude) || 0, parseFloat(record.latitude) || 0]
                    },
                    properties: {
                        id: record.propertyId,
                        name: record.propertyName,
                        district: record.districtCity || record.district,
                        subcounty: record.subcounty,
                        parish: record.parish,
                        village: record.village,
                        value: record.price,
                        size: record.size,
                        rate: record.rate,
                        ratePerAcre: record.ratePerAcre,
                        landUse: record.landUse,
                        dataSource: record.dataSource,
                        officer: record.officerName,
                        officerEmail: record.officerEmail,
                        submissionDate: record.submissionDate ? formatDate(record.submissionDate) : '',
                        userId: record.userId
                    }
                })).filter(f => f.geometry.coordinates[0] !== 0 && f.geometry.coordinates[1] !== 0)
            };
            
            const dataStr = JSON.stringify(geoJson, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `approved_properties_${new Date().toISOString().split('T')[0]}.geojson`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification(`Exported ${records.length} records as GeoJSON`, "success");
        }

        function exportToCSV(records) {
            const headers = ["Property ID", "Property Name", "District/City", "Subcounty", "Parish", "Village", 
                            "Market Value", "Plot Size (Ha)", "Rate/Ha", "Rate/Acre", "Land Use", "Data Source", 
                            "Officer Name", "Officer Email", "User ID", "Submission Date", "Coordinates"];
            
            const csvContent = [
                headers.join(","),
                ...records.map(record => [
                    `"${record.propertyId || ''}"`,
                    `"${record.propertyName || ''}"`,
                    `"${record.districtCity || record.district || ''}"`,
                    `"${record.subcounty || ''}"`,
                    `"${record.parish || ''}"`,
                    `"${record.village || ''}"`,
                    record.price || 0,
                    record.size || 0,
                    record.rate || 0,
                    record.ratePerAcre || 0,
                    `"${record.landUse || ''}"`,
                    `"${record.dataSource || ''}"`,
                    `"${record.officerName || ''}"`,
                    `"${record.officerEmail || ''}"`,
                    `"${record.userId || ''}"`,
                    `"${record.submissionDate ? formatDate(record.submissionDate) : ''}"`,
                    `"${record.coordinates || ''}"`
                ].join(","))
            ].join("\n");
            
            const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csvContent);
            const exportFileDefaultName = `approved_properties_${new Date().toISOString().split('T')[0]}.csv`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification(`Exported ${records.length} records as CSV`, "success");
        }

        function exportToExcel(records) {
            exportToCSV(records);
        }

        function exportFilteredApproved() {
            const dateFrom = document.getElementById('exportDateFrom').value;
            const dateTo = document.getElementById('exportDateTo').value;
            const officer = document.getElementById('exportOfficer').value;
            const district = document.getElementById('exportDistrict').value;
            
            let filtered = allRecords.filter(r => (r.validationStatus || r.status) === 'approved');
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filtered = filtered.filter(r => {
                    const recordDate = parseFirestoreDate(r.submissionDate);
                    return recordDate && recordDate >= fromDate;
                });
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filtered = filtered.filter(r => {
                    const recordDate = parseFirestoreDate(r.submissionDate);
                    return recordDate && recordDate <= toDate;
                });
            }
            
            if (officer !== 'all') {
                filtered = filtered.filter(r => r.officerEmail === officer);
            }
            
            if (district !== 'all') {
                filtered = filtered.filter(r => (r.districtCity === district) || (r.district === district));
            }
            
            if (filtered.length === 0) {
                showNotification("No approved records match the filter criteria", "warning");
                return;
            }
            
            exportToGeoJSON(filtered);
        }

        function generateReport(type) {
            showNotification(`Generating ${type} report...`, "info");
            setTimeout(() => {
                showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} report generated successfully`, "success");
            }, 1500);
        }

        // ============================================
        // DATA LOADING WITH PAGINATION
        // ============================================
        async function loadProperties(isNextPage = false) {
            if (isLoadingMore) return;
            
            const container = document.getElementById('recordList');
            const loadingIndicator = document.getElementById('loadingMore');
            const loadMoreBtn = document.getElementById('loadMoreBtn');

            isLoadingMore = true;
            if (loadingIndicator) loadingIndicator.classList.add('active');
            if (loadMoreBtn) loadMoreBtn.disabled = true;

            try {
                // Use the 'date' field as shown in data structure for ordering
                let query = db.collection('properties')
                              .orderBy('date', 'desc')
                              .limit(PAGE_SIZE);

                if (isNextPage && lastVisibleDoc) {
                    query = query.startAfter(lastVisibleDoc);
                } else {
                    container.innerHTML = '';
                    markersGroup.clearLayers();
                    allMarkers.clear();
                    markerCallouts.clear();
                    lastVisibleDoc = null;
                }

                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    document.getElementById('loadMoreContainer').style.display = 'none';
                    return;
                }

                lastVisibleDoc = snapshot.docs[snapshot.docs.length - 1];

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    
                    processAndStoreRecord(id, data);
                    renderPropertyListItem(id, data); 
                    addPropertyToCluster(id, data);
                });

                updateStats();
                updateOfficerFilter();
                updateAnalyticsView();
                
                document.getElementById('loadMoreContainer').style.display = 
                    snapshot.docs.length === PAGE_SIZE ? 'block' : 'none';
                    
                document.getElementById('totalRecords').textContent = allRecords.length;

            } catch (error) {
                console.error("Pagination Error:", error);
                showNotification("Error loading data: " + error.message, "danger");
            } finally {
                isLoadingMore = false;
                if (loadingIndicator) loadingIndicator.classList.remove('active');
                if (loadMoreBtn) loadMoreBtn.disabled = false;
                
                lastLoadTime = new Date();
                const now = new Date();
                document.getElementById('lastRefresh').innerText = `Last refresh: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            }
        }

        // ============================================
        // REAL-TIME LISTENER
        // ============================================
        function setupRealTimeListener() {
            db.collection('properties')
                .where('status', '==', 'pending')
                .orderBy('date', 'desc')
                .limit(1)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            const id = change.doc.id;
                            
                            if (lastLoadTime && data.date) {
                                try {
                                    const recordTime = parseFirestoreDate(data.date);
                                    
                                    if (recordTime && recordTime > lastLoadTime) {
                                        const processed = processAndStoreRecord(id, data);
                                        newSubmissions.push({
                                            firebaseId: id,
                                            ...processed
                                        });
                                        
                                        updateStats();
                                        
                                        createAdminNotification({
                                            title: 'New Property Submission',
                                            message: `New property ${data.propertyId || id} submitted by ${data.officerName || data.userName || 'Unknown Officer'}`,
                                            type: 'new-submission',
                                            propertyId: data.propertyId,
                                            recipientEmail: currentUser ? currentUser.email : '',
                                            showToast: true
                                        });
                                    }
                                } catch (e) {
                                    console.warn("Error checking new submission date", e);
                                }
                            }
                        }
                    });
                });
        }

        // ============================================
        // PERIODIC UPDATES
        // ============================================
        function startPeriodicUpdates() {
            setInterval(() => {
                if (currentUser && document.visibilityState === 'visible') {
                    loadProperties(false);
                }
            }, 5 * 60 * 1000);
            
            setInterval(() => {
                if (lastLoadTime) {
                    const now = new Date();
                    const diffMins = Math.round((now - lastLoadTime) / 60000);
                    document.getElementById('lastRefresh').innerText = 
                        `Last refresh: ${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                }
            }, 60 * 1000);
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        window.onload = async () => {
            console.log("Page loaded, initializing...");
            
            initMap();

            const savedEmail = localStorage.getItem('lavmis_admin_email');
            const savedPassword = localStorage.getItem('lavmis_admin_password');
            const rememberMe = localStorage.getItem('lavmis_remember_me') === 'true';
            
            if (rememberMe && savedEmail && savedPassword) {
                document.getElementById('email').value = savedEmail;
                document.getElementById('password').value = savedPassword;
                document.querySelector('.toggle-switch').classList.add('active');
            }

            auth.onAuthStateChanged(async user => {
                console.log("Auth state changed:", user ? "User logged in" : "No user");
                if (user) {
                    try {
                        const connectionTest = await testFirestoreConnection();
                        if (!connectionTest) {
                            throw new Error("Firestore connection failed");
                        }
                        
                        let adminSnap;
                        try {
                            adminSnap = await db.collection('authorized_admins')
                                .where('email', '==', user.email)
                                .limit(1)
                                .get();
                        } catch (authError) {
                            console.error("Error checking admin authorization:", authError);
                            console.warn("Using fallback authorization - assuming user is admin");
                            adminSnap = {
                                empty: false,
                                docs: [{
                                    id: 'fallback',
                                    data: () => ({
                                        name: 'Administrator',
                                        email: user.email,
                                        role: 'admin'
                                    })
                                }]
                            };
                        }
                        
                        if (!adminSnap.empty) {
                            currentUser = user;
                            const adminData = adminSnap.docs[0].data();
                            
                            document.getElementById('loginModal').style.display = 'none';
                            document.getElementById('adminEmail').innerText = `${adminData.name || 'Admin'} (${user.email})`;
                            document.getElementById('adminEmail').title = `Role: ${adminData.role || 'admin'}`;
                            
                            lastLoadTime = new Date();
                            
                            await loadProperties(false);
                            
                            setupRealTimeListener();
                            setupAdminNotificationsListener();
                            startPeriodicUpdates();
                        } else {
                            showNotification("You are not authorized to access the admin console.", "danger");
                            await auth.signOut();
                        }
                    } catch (error) {
                        console.error("Auth state change error:", error);
                        showNotification(`Authentication error: ${error.message}`, "danger");
                        await auth.signOut();
                    }
                } else {
                    document.getElementById('loginModal').style.display = 'flex';
                    if (adminNotificationListener) {
                        adminNotificationListener();
                        adminNotificationListener = null;
                    }
                }
            });
        };

    </script>
</body>
</html>
